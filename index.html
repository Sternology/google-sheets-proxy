<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Budget Performance Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .gauge-chart {
            position: relative;
            width: 120px;
            height: 120px;
        }
        .gauge-svg {
            transform: rotate(-90deg);
        }
        .gauge-bg {
            fill: none;
            stroke: #f3f4f6;
            stroke-width: 15;
        }
        .gauge-fill {
            fill: none;
            stroke-width: 15;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }
        .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;
        
        // Custom SVG Gauge Component
        const GaugeChart = ({ value, maxValue, color, label, displayValue }) => {
            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const percentage = Math.min(value / maxValue, 1);
            const strokeDashoffset = circumference - (percentage * circumference);

            return (
                <div className="relative bg-white p-4 rounded-lg border border-gray-200">
                    <div className="text-center mb-2">
                        <div className="text-xs font-medium text-gray-600">{label}</div>
                    </div>
                    <div className="gauge-chart mx-auto">
                        <svg className="gauge-svg" width="120" height="120">
                            <circle
                                cx="60"
                                cy="60"
                                r={radius}
                                className="gauge-bg"
                            />
                            <circle
                                cx="60"
                                cy="60"
                                r={radius}
                                className="gauge-fill"
                                style={{
                                    stroke: color,
                                    strokeDasharray: circumference,
                                    strokeDashoffset: strokeDashoffset
                                }}
                            />
                        </svg>
                        <div className="gauge-text">
                            <div className="text-lg font-bold" style={{ color }}>
                                {displayValue}
                            </div>
                            <div className="text-xs text-gray-500">{label.split(' ')[0]}</div>
                        </div>
                    </div>
                </div>
            );
        };

        // Budget Adjustment Recommendation Component
        const BudgetAdjustmentCard = ({ client }) => {
            const calculateTargetDailyBudget = () => {
                if (client.daysLeft <= 0) return { recommended: 0, change: 0, message: "Period ended" };
                
                if (client.total >= client.budget) {
                    return {
                        recommended: 0,
                        change: -client.currentDailyBudget,
                        changePercentage: -100,
                        message: "Already over budget - pause campaigns to avoid further overspend",
                        urgency: "critical"
                    };
                }
                
                const remainingBudget = client.budget - client.total;
                const targetDailySpend = remainingBudget / client.daysLeft;
                const recommendedDailyBudget = Math.max(0, targetDailySpend);
                const currentDailyBudget = client.currentDailyBudget;
                const change = recommendedDailyBudget - currentDailyBudget;
                const changePercentage = currentDailyBudget > 0 ? (change / currentDailyBudget) * 100 : 0;
                
                let message = "";
                let urgency = "normal";
                
                if (Math.abs(changePercentage) < 5) {
                    message = "Current budget is close to optimal";
                    urgency = "good";
                } else if (change > 0) {
                    message = `Increase budget to hit target (${changePercentage.toFixed(0)}% increase needed)`;
                    urgency = "increase";
                } else {
                    message = `Decrease budget to avoid overspend (${Math.abs(changePercentage).toFixed(0)}% decrease needed)`;
                    urgency = "decrease";
                }
                
                return {
                    recommended: recommendedDailyBudget,
                    change: change,
                    changePercentage: changePercentage,
                    message: message,
                    urgency: urgency
                };
            };

            const calculatePlatformRecommendations = () => {
                const adjustment = calculateTargetDailyBudget();
                
                if (adjustment.recommended <= 0) {
                    return {
                        google: 0,
                        facebook: 0,
                        googleChange: -client.googleDailyBudget,
                        facebookChange: -client.facebookDailyBudget
                    };
                }
                
                const totalCurrentBudget = client.googleDailyBudget + client.facebookDailyBudget;
                
                if (totalCurrentBudget <= 0) {
                    return {
                        google: adjustment.recommended / 2,
                        facebook: adjustment.recommended / 2,
                        googleChange: (adjustment.recommended / 2) - client.googleDailyBudget,
                        facebookChange: (adjustment.recommended / 2) - client.facebookDailyBudget
                    };
                }
                
                const googleRatio = client.googleDailyBudget / totalCurrentBudget;
                const facebookRatio = client.facebookDailyBudget / totalCurrentBudget;
                
                const recommendedGoogle = adjustment.recommended * googleRatio;
                const recommendedFacebook = adjustment.recommended * facebookRatio;
                
                return {
                    google: recommendedGoogle,
                    facebook: recommendedFacebook,
                    googleChange: recommendedGoogle - client.googleDailyBudget,
                    facebookChange: recommendedFacebook - client.facebookDailyBudget
                };
            };

            const adjustment = calculateTargetDailyBudget();
            const platformRecs = calculatePlatformRecommendations();

            if (client.status === 'ON TRACK') {
                return (
                    <div className="mt-4 p-4 rounded-lg bg-green-50 border border-green-200">
                        <div className="flex items-center justify-center text-green-800">
                            <span className="text-lg">✅</span>
                            <div className="ml-2">
                                <div className="font-bold">Budget On Track</div>
                                <div className="text-sm">Current daily budget of £{client.currentDailyBudget.toFixed(0)} is optimal</div>
                            </div>
                        </div>
                    </div>
                );
            }

            const getCardStyle = () => {
                switch (adjustment.urgency) {
                    case 'critical':
                        return 'bg-red-50 border-red-300 text-red-900';
                    case 'increase':
                        return 'bg-blue-50 border-blue-300 text-blue-900';
                    case 'decrease':
                        return 'bg-orange-50 border-orange-300 text-orange-900';
                    default:
                        return 'bg-gray-50 border-gray-300 text-gray-900';
                }
            };

            const getIcon = () => {
                switch (adjustment.urgency) {
                    case 'critical':
                        return '🚨';
                    case 'increase':
                        return '📈';
                    case 'decrease':
                        return '📉';
                    default:
                        return '⚙️';
                }
            };

            return (
                <div className={`mt-4 p-4 rounded-lg border-2 ${getCardStyle()}`}>
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center">
                            <span className="text-xl mr-2">{getIcon()}</span>
                            <div>
                                <div className="font-bold text-sm">Budget Adjustment Needed</div>
                                <div className="text-xs opacity-75">{adjustment.message}</div>
                            </div>
                        </div>
                        {adjustment.urgency === 'critical' && (
                            <div className="text-xs bg-red-200 px-2 py-1 rounded font-bold">
                                URGENT
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <div className="text-xs font-medium opacity-75">TOTAL DAILY BUDGET</div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm">Current:</span>
                                <span className="font-bold">£{client.currentDailyBudget.toFixed(0)}/day</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm">Recommended:</span>
                                <span className="font-bold text-lg">£{adjustment.recommended.toFixed(0)}/day</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm">Change:</span>
                                <span className={`font-bold ${adjustment.change > 0 ? 'text-blue-700' : 'text-orange-700'}`}>
                                    {adjustment.change > 0 ? '+' : ''}£{adjustment.change.toFixed(0)}/day
                                    {Math.abs(adjustment.changePercentage) > 1 && (
                                        <span className="text-xs ml-1">
                                            ({adjustment.changePercentage > 0 ? '+' : ''}{adjustment.changePercentage.toFixed(0)}%)
                                        </span>
                                    )}
                                </span>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <div className="text-xs font-medium opacity-75">PLATFORM BREAKDOWN</div>
                            
                            {(client.googleDailyBudget > 0 || platformRecs.google > 0) && (
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-orange-600">Google:</span>
                                    <div className="text-right">
                                        <div className="font-semibold">£{platformRecs.google.toFixed(0)}/day</div>
                                        {Math.abs(platformRecs.googleChange) > 1 && (
                                            <div className={`text-xs ${platformRecs.googleChange > 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                ({platformRecs.googleChange > 0 ? '+' : ''}£{platformRecs.googleChange.toFixed(0)})
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {(client.facebookDailyBudget > 0 || platformRecs.facebook > 0) && (
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-purple-600">Meta:</span>
                                    <div className="text-right">
                                        <div className="font-semibold">£{platformRecs.facebook.toFixed(0)}/day</div>
                                        {Math.abs(platformRecs.facebookChange) > 1 && (
                                            <div className={`text-xs ${platformRecs.facebookChange > 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                ({platformRecs.facebookChange > 0 ? '+' : ''}£{platformRecs.facebookChange.toFixed(0)})
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="mt-3 pt-3 border-t border-current opacity-50">
                        <div className="text-xs">
                            <span className="font-medium">With this change:</span>
                            {" "}Final spend would be approximately £{(client.total + (adjustment.recommended * client.daysLeft)).toFixed(0)}
                            {" "}({((client.total + (adjustment.recommended * client.daysLeft)) / client.budget * 100).toFixed(0)}% of target)
                        </div>
                    </div>
                </div>
            );
        };

        const ClientBudgetTable = () => {
            const [rawData, setRawData] = useState({});
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [logs, setLogs] = useState([]);

            // Configuration
            const PROXY_URL = 'https://sheets-proxy-ria9.vercel.app/api/sheets-proxy';
            const SPREADSHEET_ID = '1nbVrRxhIh2RLa5qtOsaM1N_UmqljztVwxPbQRCnkBcs';
            const API_KEY = 'AIzaSyDffl5VtZDXxAMJ-Cnbay7CbO-PPfF42fI';
            const VERSION = 'v2.17.0'; // Fixed Google data deduplication for Apollo

            const getCurrentPeriod = useCallback((clientType) => {
                const today = new Date();
                
                if (clientType === 'apollo') {
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    const day = today.getDate();
                    
                    let startMonth, endMonth;
                    let startYear = currentYear;
                    let endYear = currentYear;
                    
                    if (day >= 26) {
                        startMonth = currentMonth;
                        endMonth = currentMonth + 1;
                        if (endMonth > 11) {
                            endMonth = 0;
                            endYear = currentYear + 1;
                        }
                    } else {
                        startMonth = currentMonth - 1;
                        endMonth = currentMonth;
                        if (startMonth < 0) {
                            startMonth = 11;
                            startYear = currentYear - 1;
                        }
                    }
                    
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${monthNames[startMonth]} 26 - ${monthNames[endMonth]} 25`;
                } else if (clientType === 'hc1') {
                    const currentMonth = today.getMonth();
                    const day = today.getDate();
                    
                    let startMonth, endMonth;
                    
                    if (day >= 11) {
                        startMonth = currentMonth;
                        endMonth = currentMonth + 1;
                    } else {
                        startMonth = currentMonth - 1;
                        endMonth = currentMonth;
                    }
                    
                    if (startMonth < 0) startMonth = 11;
                    if (endMonth > 11) endMonth = 0;
                    
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${monthNames[startMonth]} 11 - ${monthNames[endMonth]} 10`;
                } else {
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const currentMonthName = monthNames[currentMonth];
                    const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
                    
                    return `${currentMonthName} 1 - ${currentMonthName} ${lastDay}`;
                }
            }, []);

            const getTotalDays = useCallback((clientType) => {
                if (clientType === 'apollo' || clientType === 'hc1') {
                    return 30;
                } else {
                    const today = new Date();
                    return new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                }
            }, []);

            const clientConfig = useMemo(() => ({
                'Apollo': {
                    campaigns: [
                        'Always on HCA & Support Works National Search',
                        'North West Conversions Campaign April 30th'
                    ],
                    budget: 1221,
                    period: getCurrentPeriod('apollo'),
                    totalDays: getTotalDays('apollo')
                },
                'Cygnet Care': {
                    campaigns: ['Care and Support Always On Performance Max', 'Care and Support Always On - Conversions 2025', 'Care and Support Always On - Traffic - 2024'],
                    budget: 800,
                    period: getCurrentPeriod('standard'),
                    totalDays: getTotalDays('standard'),
                    tabPrefix: 'Cygnet'
                },
                'Cygnet Nursing': {
                    campaigns: ['Nursing always on Performance Max', 'Always On Nursing Search', 'Nursing Always on April 2024'],
                    budget: 800,
                    period: getCurrentPeriod('standard'),
                    totalDays: getTotalDays('standard'),
                    tabPrefix: 'Cygnet',
                    skipTabs: true
                },
                'HC-One - England/Wales': {
                    campaigns: [
                        'AL -  Always on Care Search Campaign',
                        'Always on Care',
                        'HC-One Always On Campaign'
                    ],
                    budget: 1800,
                    period: getCurrentPeriod('hc1'),
                    totalDays: getTotalDays('hc1'),
                    tabPrefix: 'HC1'
                },
                'HC-One - Scotland': {
                    campaigns: [
                        'AL - Scotland Always on Care Search Campaign',
                        'Always on Care – Scotland'
                    ],
                    budget: 1000,
                    period: getCurrentPeriod('hc1'),
                    totalDays: getTotalDays('hc1'),
                    tabPrefix: 'HC1',
                    skipTabs: true
                }
            }), [getCurrentPeriod, getTotalDays]);

            const addLog = useCallback((message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [...prev, { message, type, timestamp }]);
                console.log(`[${timestamp}] ${message}`);
            }, []);

            const clearLogs = useCallback(() => {
                setLogs([]);
            }, []);

            const parseDateRange = (dateRange) => {
                const parts = dateRange.split(' - ');
                if (parts.length !== 2) return { start: null, end: null };
                
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                const currentDay = today.getDate();
                
                const monthMap = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                };
                
                const [startMonthName, startDayStr] = parts[0].trim().split(' ');
                const [endMonthName, endDayStr] = parts[1].trim().split(' ');
                
                const startMonthIndex = monthMap[startMonthName];
                const endMonthIndex = monthMap[endMonthName];
                const startDay = parseInt(startDayStr);
                const endDay = parseInt(endDayStr);
                
                let startYear = currentYear;
                let endYear = currentYear;
                
                if (startDay === 26 && endDay === 25) {
                    if (currentDay >= 26) {
                        if (startMonthIndex === currentMonth) {
                            startYear = currentYear;
                            if (endMonthIndex < startMonthIndex) {
                                endYear = currentYear + 1;
                            } else {
                                endYear = currentYear;
                            }
                        }
                    } else {
                        if (endMonthIndex === currentMonth) {
                            endYear = currentYear;
                            if (startMonthIndex > endMonthIndex) {
                                startYear = currentYear - 1;
                            } else {
                                startYear = currentYear;
                            }
                        }
                    }
                } else if (startDay === 11 && endDay === 10) {
                    if (currentDay >= 11) {
                        if (startMonthIndex === currentMonth) {
                            startYear = currentYear;
                            endYear = currentMonth === 11 ? currentYear + 1 : currentYear;
                        }
                    } else {
                        if (endMonthIndex === currentMonth) {
                            endYear = currentYear;
                            startYear = startMonthIndex === 11 && currentMonth === 0 ? currentYear - 1 : currentYear;
                        }
                    }
                }
                
                const startDate = new Date(startYear, startMonthIndex, startDay);
                const endDate = new Date(endYear, endMonthIndex, endDay);
                
                return { start: startDate, end: endDate };
            };

            const isDateInRange = (date, startDate, endDate) => {
                const checkDate = new Date(date);
                const normalizedCheck = new Date(checkDate.getFullYear(), checkDate.getMonth(), checkDate.getDate());
                const normalizedStart = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                const normalizedEnd = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
                
                return normalizedCheck >= normalizedStart && normalizedCheck <= normalizedEnd;
            };

            const loadData = async () => {
                clearLogs();
                addLog('Starting data load process...', 'info');
                setLoading(true);
                setError(null);

                try {
                    const allData = {};
                    const expectedTabs = ['Apollo Google', 'Apollo FB', 'Cygnet Google', 'Cygnet FB', 'HC1 Google', 'HC1 FB'];

                    for (const tabName of expectedTabs) {
                        try {
                            addLog(`Fetching data from tab: ${tabName}`, 'info');
                            
                            const range = tabName.includes('FB') ? `${tabName}!A:E` : `${tabName}!A:F`;
                            const url = `${PROXY_URL}?spreadsheetId=${SPREADSHEET_ID}&range=${encodeURIComponent(range)}&apiKey=${API_KEY}`;
                            
                            const response = await fetch(url);
                            
                            if (response.ok) {
                                const data = await response.json();
                                
                                if (data.values && data.values.length > 1) {
                                    const headers = data.values[0];
                                    const rows = data.values.slice(1);
                                    
                                    const tabData = rows.map(row => {
                                        const rowData = {};
                                        headers.forEach((header, index) => {
                                            if (tabName.includes('FB')) {
                                                if (header === 'Campaign name') {
                                                    rowData['Campaign'] = row[index] || '';
                                                } else if (header === 'Amount spent (GBP)') {
                                                    rowData['Cost'] = row[index] || '';
                                                } else if (header === 'Adset name') {
                                                    rowData['AdsetName'] = row[index] || '';
                                                } else if (header === 'Adset daily budget') {
                                                    rowData['DailyBudget'] = row[index] || '';
                                                } else {
                                                    rowData[header] = row[index] || '';
                                                }
                                            } else {
                                                if (header === 'Budget Amount') {
                                                    rowData['DailyBudget'] = row[index] || '';
                                                } else {
                                                    rowData[header] = row[index] || '';
                                                }
                                            }
                                        });
                                        return rowData;
                                    });
                                    
                                    allData[tabName] = tabData;
                                    addLog(`✅ Loaded ${tabData.length} rows from ${tabName}`, 'success');
                                }
                            }
                        } catch (tabError) {
                            addLog(`❌ Error fetching tab ${tabName}: ${tabError.message}`, 'error');
                        }
                    }

                    setRawData(allData);
                    addLog(`🎉 Data loading complete! Loaded ${Object.keys(allData).length} tabs`, 'success');

                } catch (err) {
                    setError(err.message);
                    addLog(`💥 Fatal error: ${err.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const processRawData = useCallback((data) => {
                const today = new Date();
                const processedClients = [];

                Object.keys(clientConfig).forEach(clientName => {
                    const config = clientConfig[clientName];
                    const tabPrefix = config.tabPrefix || clientName;
                    const { start: periodStart, end: periodEnd } = parseDateRange(config.period);
                    
                    if (!periodStart || !periodEnd) return;

                    const daysElapsed = Math.ceil((today - periodStart) / (1000 * 60 * 60 * 24)) + 1;
                    const daysLeft = Math.max(0, Math.ceil((periodEnd - today) / (1000 * 60 * 60 * 24)) + 1);

                    let googleSpend = 0;
                    let facebookSpend = 0;
                    let dailySpend = {};
                    let googleDailyBudget = 0;
                    let facebookDailyBudget = 0;

                    // Process Google data with deduplication
                    const googleTabName = `${tabPrefix} Google`;
                    if (data[googleTabName]) {
                        let rowsMatched = 0;
                        let rowsBeforeDedup = 0;
                        let latestDate = null;
                        let latestDateBudget = 0;
                        
                        const filteredRows = [];
                        const seenKeys = new Set();
                        
                        data[googleTabName].forEach(row => {
                            const campaign = row.Campaign || '';
                            const cost = parseFloat(row.Cost) || 0;
                            const dailyBudget = parseFloat(row.DailyBudget) || 0;

                            const matchesCampaign = config.campaigns.includes('*') || 
                                                 config.campaigns.some(c => campaign === c);

                            if (matchesCampaign && isDateInRange(row.Date, periodStart, periodEnd)) {
                                rowsBeforeDedup++;
                                
                                const uniqueKey = `${row.Date}-${campaign}`;
                                
                                if (!seenKeys.has(uniqueKey)) {
                                    seenKeys.add(uniqueKey);
                                    filteredRows.push(row);
                                    rowsMatched++;
                                    googleSpend += cost;
                                    
                                    const dateKey = row.Date;
                                    if (!dailySpend[dateKey]) dailySpend[dateKey] = 0;
                                    dailySpend[dateKey] += cost;

                                    const rowDate = new Date(row.Date);
                                    if (!latestDate || rowDate > latestDate) {
                                        latestDate = rowDate;
                                        latestDateBudget = 0;
                                    }
                                    
                                    if (rowDate.getTime() === latestDate.getTime() && dailyBudget > 0) {
                                        if (clientName === 'Apollo') {
                                            latestDateBudget = dailyBudget;
                                        } else {
                                            latestDateBudget = Math.max(latestDateBudget, dailyBudget);
                                        }
                                    }
                                }
                            }
                        });

                        googleDailyBudget = latestDateBudget;
                        
                        if (clientName === 'Apollo') {
                            addLog(`🔍 APOLLO Google BEFORE dedup: ${rowsBeforeDedup} rows found`, 'info');
                            addLog(`🔍 APOLLO Google AFTER dedup: ${rowsMatched} unique rows, £${googleSpend.toFixed(2)} spend, £${googleDailyBudget.toFixed(2)} daily budget`, 'info');
                            
                            const uniqueDates = [...new Set(filteredRows.
