<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Client Budget Performance Dashboard</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.8.0/umd/Recharts.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const waitForRecharts = () => {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const interval = setInterval(() => {
          const R = window.Recharts;
          if (R && R.PieChart && R.LineChart) {
            clearInterval(interval);
            resolve(R);
          }
          if (++attempts > 100) {
            clearInterval(interval);
            reject(new Error('Recharts failed to load after 5 seconds'));
          }
        }, 50);
      });
    };

    const PROXY_URL = 'https://sheets-proxy-ria9.vercel.app/api/sheets-proxy';
    const SPREADSHEET_ID = '1nbVrRxhIh2RLa5qtOsaM1N_UmqljztVwxPbQRCnkBcs';
    const API_KEY = 'AIzaSyDffl5VtZDXxAMJ-Cnbay7CbO-PPfF42fI';

    const Dashboard = () => {
      const [clients, setClients] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [Recharts, setRecharts] = useState(null);

      useEffect(() => {
        waitForRecharts()
          .then((lib) => setRecharts(lib))
          .catch((err) => setError(err.message));
      }, []);

      useEffect(() => {
        if (!Recharts) return;

        const fetchData = async () => {
          try {
            const clientTabs = [
              { name: 'Apollo', tab: 'Apollo Google', budget: 1200 },
              { name: 'HC-One', tab: 'HC1 Google', budget: 1800 }
            ];

            const responses = await Promise.all(
              clientTabs.map(c => fetch(`${PROXY_URL}?spreadsheetId=${SPREADSHEET_ID}&range=${encodeURIComponent(`${c.tab}!A:F`)}&apiKey=${API_KEY}`))
            );

            const jsonResults = await Promise.all(responses.map(r => r.json()));

            const processed = jsonResults.map((result, i) => {
              const rows = result.values?.slice(1) || [];
              let spend = 0;
              const trend = {};

              rows.forEach(row => {
                const date = row[0];
                const cost = parseFloat(row[2] || 0);
                const day = new Date(date).getDate();
                spend += cost;
                if (!trend[day]) trend[day] = 0;
                trend[day] += cost;
              });

              return {
                name: clientTabs[i].name,
                spend,
                budget: clientTabs[i].budget,
                trend: Array.from({ length: 31 }, (_, d) => ({
                  day: d + 1,
                  spend: trend[d + 1] || 0,
                  target: clientTabs[i].budget / 30
                }))
              };
            });

            setClients(processed);
            setLoading(false);
          } catch (err) {
            setError('Failed to load data');
            setLoading(false);
          }
        };

        fetchData();
      }, [Recharts]);

      if (!Recharts) return <div className="p-6">Loading Recharts library...</div>;

      const { PieChart, Pie, Cell, LineChart, Line, XAxis, YAxis, CartesianGrid, ResponsiveContainer, Tooltip } = Recharts;
      const COLORS = ['#10B981', '#F59E0B', '#EF4444'];

      const BudgetGauge = ({ percent }) => {
        const clamped = Math.min(percent, 130);
        const data = [
          { name: 'Used', value: clamped },
          { name: 'Remaining', value: 130 - clamped }
        ];
        const color = percent < 60 ? COLORS[0] : percent < 100 ? COLORS[1] : COLORS[2];

        return (
          <PieChart width={120} height={120}>
            <Pie
              data={data}
              startAngle={180}
              endAngle={0}
              innerRadius={40}
              outerRadius={55}
              dataKey="value"
            >
              {data.map((entry, index) => (
                <Cell key={`cell-${index}`} fill={index === 0 ? color : '#E5E7EB'} />
              ))}
            </Pie>
          </PieChart>
        );
      };

      const SpendTrend = ({ trendData }) => (
        <ResponsiveContainer width="100%" height={150}>
          <LineChart data={trendData}>
            <CartesianGrid strokeDasharray="3 3" stroke="#f3f4f6" />
            <XAxis dataKey="day" tick={{ fontSize: 10 }} />
            <YAxis hide />
            <Tooltip />
            <Line type="monotone" dataKey="spend" stroke="#3B82F6" strokeWidth={2} />
            <Line type="monotone" dataKey="target" stroke="#F59E0B" strokeDasharray="4 4" />
          </LineChart>
        </ResponsiveContainer>
      );

      return (
        <div className="p-6 bg-gray-100 min-h-screen">
          <h1 className="text-2xl font-bold mb-6">Client Budget Dashboard</h1>
          {loading ? (
            <p className="text-blue-500">Loading...</p>
          ) : error ? (
            <p className="text-red-600">{error}</p>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {clients.map((client, i) => {
                const percent = (client.spend / client.budget) * 100;
                return (
                  <div key={i} className="bg-white p-4 rounded shadow border">
                    <div className="flex justify-between items-center">
                      <div>
                        <h2 className="text-lg font-bold">{client.name}</h2>
                        <p className="text-sm text-gray-500">
                          Spend: £{client.spend.toFixed(0)} / £{client.budget}
                        </p>
                      </div>
                      <BudgetGauge percent={percent} />
                    </div>
                    <div className="mt-4">
                      <SpendTrend trendData={client.trend} />
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<Dashboard />);
  </script>
</body>
</html>
