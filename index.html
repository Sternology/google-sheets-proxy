<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Budget Performance Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; }
        .gauge-chart { position: relative; width: 120px; height: 120px; }
        .gauge-svg { transform: rotate(-90deg); }
        .gauge-bg { fill: none; stroke: #f3f4f6; stroke-width: 15; }
        .gauge-fill { fill: none; stroke-width: 15; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .gauge-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .collapsible-content { overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease-out; }
        .collapsible-content.collapsed { max-height: 0; opacity: 0; }
        .collapsible-content.expanded { max-height: 800px; opacity: 1; }
        .chevron { transition: transform 0.3s ease; }
        .chevron.rotated { transform: rotate(180deg); }
        .kpi-badge { position: relative; overflow: hidden; }
        .kpi-badge::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: currentColor; opacity: 0.3; }
        @keyframes pulseGreen { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes pulseRed { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .trend-positive { animation: pulseGreen 2s infinite; }
        .trend-negative { animation: pulseRed 2s infinite; }
        .trend-arrow { display: inline-block; transition: transform 0.2s ease; font-weight: bold; }
        .trend-arrow.up { transform: translateY(-1px); }
        .trend-arrow.down { transform: translateY(1px); }
        .kpi-badge.trend-up { background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.1) 100%); }
        .kpi-badge.trend-down { background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.1) 100%); }
        .historical-badge { background: linear-gradient(135deg, rgba(156, 163, 175, 0.1) 0%, rgba(156, 163, 175, 0.2) 100%); border: 2px solid rgba(156, 163, 175, 0.3); }
        .hit-target { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.2) 100%); border-color: rgba(16, 185, 129, 0.4); }
        .missed-target { background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.2) 100%); border-color: rgba(239, 68, 68, 0.4); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;
        
        // --- COMPONENTS ---
        
        const MonthSelector = ({ selectedMonth, onMonthChange, availableMonths }) => {
            return (
                <div className="flex items-center gap-3">
                    <label className="text-sm font-medium text-gray-700">View Period:</label>
                    <select
                        value={selectedMonth}
                        onChange={(e) => onMonthChange(e.target.value)}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                    >
                        {availableMonths.map(month => (
                            <option key={month.value} value={month.value}>
                                {month.label} {month.isCurrent ? '(Current)' : ''}
                            </option>
                        ))}
                    </select>
                    {selectedMonth !== 'current' && (
                        <span className="text-xs text-gray-500 italic">
                            Viewing historical data
                        </span>
                    )}
                </div>
            );
        };
        
        const KPIScorecard = ({ label, value, unit, trend, performance, icon, invertTrend = false, previousValue = null }) => {
            const getPerformanceColor = () => {
                switch(performance) {
                    case 'excellent': return 'text-green-600 bg-green-50 border-green-200';
                    case 'good': return 'text-blue-600 bg-blue-50 border-blue-200';
                    case 'average': return 'text-yellow-600 bg-yellow-50 border-yellow-200';
                    case 'poor': return 'text-red-600 bg-red-50 border-red-200';
                    default: return 'text-gray-600 bg-gray-50 border-gray-200';
                }
            };
            const getTrendColor = () => {
                if (trend === null || trend === undefined || trend === 0) return 'text-gray-400';
                const isPositiveTrend = invertTrend ? trend < 0 : trend > 0;
                return isPositiveTrend ? 'text-green-600 trend-positive' : 'text-red-600 trend-negative';
            };
            const getTrendIcon = () => {
                if (trend === null || trend === undefined || trend === 0) return '‚Üí';
                return trend > 0 ? '‚Üë' : '‚Üì';
            };
            const getTrendClass = () => {
                if (trend === null || trend === undefined || trend === 0) return '';
                const isPositiveTrend = invertTrend ? trend < 0 : trend > 0;
                return isPositiveTrend ? 'trend-up' : 'trend-down';
            };
            const formatTrend = () => {
                if (trend === null || trend === undefined) return null;
                return Math.abs(trend).toFixed(0);
            };

            return (
                <div className={`kpi-badge p-3 rounded-lg border ${getPerformanceColor()} transition-all hover:shadow-md ${getTrendClass()}`}>
                    <div className="flex items-start justify-between mb-1">
                        <div className="flex items-center">
                            <span className="text-lg mr-2">{icon}</span>
                            <div className="text-xs font-medium opacity-75">{label}</div>
                        </div>
                        {trend !== null && trend !== undefined && (
                            <span className={`text-sm font-bold ${getTrendColor()}`} title={previousValue ? `Previous: ${previousValue}` : ''}>
                                <span className={`trend-arrow ${trend > 0 ? 'up' : trend < 0 ? 'down' : ''}`}>
                                    {getTrendIcon()}
                                </span>
                                {formatTrend()}%
                            </span>
                        )}
                    </div>
                    <div className="flex items-baseline">
                        <span className="text-xl font-bold">{value}</span>
                        {unit && <span className="text-xs ml-1 opacity-75">{unit}</span>}
                    </div>
                    {previousValue && (
                        <div className="text-xs opacity-60 mt-1">
                            vs {previousValue} prev period
                        </div>
                    )}
                </div>
            );
        };
        
        const GaugeChart = ({ value, maxValue, color, label, displayValue }) => {
            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const percentage = Math.min(value / maxValue, 1);
            const strokeDashoffset = circumference - (percentage * circumference);

            return (
                <div className="relative bg-white p-4 rounded-lg border border-gray-200">
                    <div className="text-center mb-2">
                        <div className="text-xs font-medium text-gray-600">{label}</div>
                    </div>
                    <div className="gauge-chart mx-auto">
                        <svg className="gauge-svg" width="120" height="120">
                            <circle cx="60" cy="60" r={radius} className="gauge-bg" />
                            <circle cx="60" cy="60" r={radius} className="gauge-fill"
                                style={{ stroke: color, strokeDasharray: circumference, strokeDashoffset: strokeDashoffset }}
                            />
                        </svg>
                        <div className="gauge-text">
                            <div className="text-lg font-bold" style={{ color }}>{displayValue}</div>
                            <div className="text-xs text-gray-500">{label.split(' ')[0]}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const BudgetAdjustmentCard = ({ client }) => {
            if (client.isHistorical) {
                const hitTarget = client.used <= 105 && client.used >= 95;
                const underBudget = client.used < 95;
                const overBudget = client.used > 105;
                return (
                    <div className={`mt-4 p-4 rounded-lg border ${
                        hitTarget ? 'bg-green-50 border-green-200' :
                        underBudget ? 'bg-blue-50 border-blue-200' : 'bg-red-50 border-red-200'
                    }`}>
                        <div className="flex items-center justify-between">
                            <div>
                                <div className="font-bold text-sm">
                                    {hitTarget ? '‚úÖ Target Hit' : underBudget ? 'üìâ Under Budget' : 'üìà Over Budget'}
                                </div>
                                <div className="text-xs opacity-75">
                                    Final spend: ¬£{client.total.toFixed(0)} of ¬£{client.budget} budget ({client.used.toFixed(1)}%)
                                </div>
                            </div>
                            <div className={`text-lg font-bold ${
                                hitTarget ? 'text-green-600' : underBudget ? 'text-blue-600' : 'text-red-600'
                            }`}>
                                {underBudget ? `-¬£${(client.budget - client.total).toFixed(0)}` :
                                 overBudget ? `+¬£${(client.total - client.budget).toFixed(0)}` : 'On Target'}
                            </div>
                        </div>
                    </div>
                );
            }
            
            const calculateTargetDailyBudget = () => {
                if (client.daysLeft <= 0) return { recommended: 0, change: 0, message: "Period ended" };
                if (client.total >= client.budget) {
                    return {
                        recommended: 0, change: -client.currentDailyBudget, changePercentage: -100,
                        message: "Already over budget - pause campaigns to avoid further overspend", urgency: "critical"
                    };
                }
                const remainingBudget = client.budget - client.total;
                const targetDailySpend = remainingBudget / client.daysLeft;
                const recommendedDailyBudget = Math.max(0, targetDailySpend);
                const currentDailyBudget = client.currentDailyBudget;
                const change = recommendedDailyBudget - currentDailyBudget;
                const changePercentage = currentDailyBudget > 0 ? (change / currentDailyBudget) * 100 : 0;
                
                let message = "";
                let urgency = "normal";
                if (Math.abs(changePercentage) < 5) {
                    message = "Current budget is close to optimal"; urgency = "good";
                } else if (change > 0) {
                    message = `Increase budget to hit target (${changePercentage.toFixed(0)}% increase needed)`; urgency = "increase";
                } else {
                    message = `Decrease budget to avoid overspend (${Math.abs(changePercentage).toFixed(0)}% decrease needed)`; urgency = "decrease";
                }
                return { recommended: recommendedDailyBudget, change: change, changePercentage: changePercentage, message: message, urgency: urgency };
            };

            const calculatePlatformRecommendations = () => {
                const adjustment = calculateTargetDailyBudget();
                if (adjustment.recommended <= 0) {
                    return { google: 0, facebook: 0, googleChange: -client.googleDailyBudget, facebookChange: -client.facebookDailyBudget };
                }
                const totalCurrentBudget = client.googleDailyBudget + client.facebookDailyBudget;
                if (totalCurrentBudget <= 0) {
                    // Assuming equal split if no current budget, or full to FB if only FB
                    if (client.name === 'Brandon Trust') {
                         return { 
                            google: 0, facebook: adjustment.recommended,
                            googleChange: 0, facebookChange: adjustment.recommended - client.facebookDailyBudget
                         };
                    }
                    return {
                        google: adjustment.recommended / 2, facebook: adjustment.recommended / 2,
                        googleChange: (adjustment.recommended / 2) - client.googleDailyBudget,
                        facebookChange: (adjustment.recommended / 2) - client.facebookDailyBudget
                    };
                }
                const googleRatio = client.googleDailyBudget / totalCurrentBudget;
                const facebookRatio = client.facebookDailyBudget / totalCurrentBudget;
                const recommendedGoogle = adjustment.recommended * googleRatio;
                const recommendedFacebook = adjustment.recommended * facebookRatio;
                return {
                    google: recommendedGoogle, facebook: recommendedFacebook,
                    googleChange: recommendedGoogle - client.googleDailyBudget, facebookChange: recommendedFacebook - client.facebookDailyBudget
                };
            };

            const adjustment = calculateTargetDailyBudget();
            const platformRecs = calculatePlatformRecommendations();

            if (client.status === 'ON TRACK') {
                return (
                    <div className="mt-4 p-4 rounded-lg bg-green-50 border border-green-200">
                        <div className="flex items-center justify-center text-green-800">
                            <span className="text-lg">‚úÖ</span>
                            <div className="ml-2">
                                <div className="font-bold">Budget On Track</div>
                                <div className="text-sm">Current daily budget of ¬£{client.currentDailyBudget.toFixed(0)} is optimal</div>
                            </div>
                        </div>
                    </div>
                );
            }

            const getCardStyle = () => {
                switch (adjustment.urgency) {
                    case 'critical': return 'bg-red-50 border-red-300 text-red-900';
                    case 'increase': return 'bg-blue-50 border-blue-300 text-blue-900';
                    case 'decrease': return 'bg-orange-50 border-orange-300 text-orange-900';
                    default: return 'bg-gray-50 border-gray-300 text-gray-900';
                }
            };

            const getIcon = () => {
                switch (adjustment.urgency) {
                    case 'critical': return 'üö®';
                    case 'increase': return 'üìà';
                    case 'decrease': return 'üìâ';
                    default: return '‚öôÔ∏è';
                }
            };

            return (
                <div className={`mt-4 p-4 rounded-lg border-2 ${getCardStyle()}`}>
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center">
                            <span className="text-xl mr-2">{getIcon()}</span>
                            <div>
                                <div className="font-bold text-sm">Budget Adjustment Needed</div>
                                <div className="text-xs opacity-75">{adjustment.message}</div>
                            </div>
                        </div>
                        {adjustment.urgency === 'critical' && (
                            <div className="text-xs bg-red-200 px-2 py-1 rounded font-bold">URGENT</div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <div className="text-xs font-medium opacity-75">TOTAL DAILY BUDGET</div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm">Current:</span>
                                <span className="font-bold">¬£{client.currentDailyBudget.toFixed(0)}/day</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm">Recommended:</span>
                                <span className="font-bold text-lg">¬£{adjustment.recommended.toFixed(0)}/day</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm">Change:</span>
                                <span className={`font-bold ${adjustment.change > 0 ? 'text-blue-700' : 'text-orange-700'}`}>
                                    {adjustment.change > 0 ? '+' : ''}¬£{adjustment.change.toFixed(0)}/day
                                    {Math.abs(adjustment.changePercentage) > 1 && (
                                        <span className="text-xs ml-1">
                                            ({adjustment.changePercentage > 0 ? '+' : ''}{adjustment.changePercentage.toFixed(0)}%)
                                        </span>
                                    )}
                                </span>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <div className="text-xs font-medium opacity-75">PLATFORM BREAKDOWN</div>
                            {(client.googleDailyBudget > 0 || platformRecs.google > 0) && (
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-orange-600">Google:</span>
                                    <div className="text-right">
                                        <div className="font-semibold">¬£{platformRecs.google.toFixed(0)}/day</div>
                                        {Math.abs(platformRecs.googleChange) > 1 && (
                                            <div className={`text-xs ${platformRecs.googleChange > 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                ({platformRecs.googleChange > 0 ? '+' : ''}¬£{platformRecs.googleChange.toFixed(0)})
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            {(client.facebookDailyBudget > 0 || platformRecs.facebook > 0) && (
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-purple-600">Meta:</span>
                                    <div className="text-right">
                                        <div className="font-semibold">¬£{platformRecs.facebook.toFixed(0)}/day</div>
                                        {Math.abs(platformRecs.facebookChange) > 1 && (
                                            <div className={`text-xs ${platformRecs.facebookChange > 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                ({platformRecs.facebookChange > 0 ? '+' : ''}¬£{platformRecs.facebookChange.toFixed(0)})
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ClientCard = ({ client }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            
            const getCardStyle = () => {
                if (client.isHistorical) {
                    const hitTarget = client.used <= 105 && client.used >= 95;
                    if (hitTarget) return 'historical-badge hit-target';
                    if (client.used < 95) return 'historical-badge';
                    return 'historical-badge missed-target';
                }
                return 'bg-green-50 border-green-300';
            };
            
            const getKPIData = () => {
                let conversionLabel = 'Conversions';
                let conversionValue = client.conversions || 0;
                let conversionIcon = 'üéØ';
                
                // Dynamic labels based on client name strings
                if (client.name.includes('HC-One')) {
                    if (client.name.includes('Nursing')) {
                        conversionLabel = 'Nurse Apps'; conversionValue = client.nursingConversions || 0; conversionIcon = 'üë©‚Äç‚öïÔ∏è';
                    } else if (client.name.includes('England/Wales')) {
                        conversionLabel = 'Care Apps'; conversionValue = client.careConversions || 0; conversionIcon = 'üè•';
                    }
                } else if (client.name === 'Apollo') {
                    conversionLabel = 'Applications'; conversionValue = (client.careConversions || 0) + (client.nursingConversions || 0); conversionIcon = 'üìã';
                } else if (client.name.includes('Cygnet Nursing')) {
                    conversionLabel = 'Nurse Apps'; conversionValue = client.nursingConversions || 0; conversionIcon = 'üë©‚Äç‚öïÔ∏è';
                } else if (client.name.includes('Cygnet Care')) {
                    conversionLabel = 'Care Apps'; conversionValue = client.careConversions || 0; conversionIcon = 'üè•';
                } else if (client.name === 'Brandon Trust') {
                    conversionLabel = 'Leads'; conversionValue = client.careConversions || 0; conversionIcon = 'üìù';
                }
                
                const cpa = conversionValue > 0 ? (client.total / conversionValue).toFixed(2) : 'N/A';
                const ctr = client.ctr || '0.00';
                
                const prevConversions = client.previousPeriod?.conversions || 
                                      client.previousPeriod?.nursingConversions || 
                                      client.previousPeriod?.careConversions || 0;
                const prevCPA = client.previousPeriod?.cpa || null;
                const prevCTR = client.previousPeriod?.ctr || null;
                
                const conversionTrend = prevConversions > 0 ? ((conversionValue - prevConversions) / prevConversions * 100) : null;
                const cpaTrend = prevCPA && cpa !== 'N/A' ? ((parseFloat(cpa) - prevCPA) / prevC
