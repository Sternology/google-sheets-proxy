<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Budget Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.8.0/Recharts.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar } = Recharts;

        const BudgetDashboard = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [dateRange, setDateRange] = useState('today');

            const clientConfig = {
                'Apollo - Ashton': {
                    campaigns: ['*'], // All campaigns
                    tabPrefix: 'Apollo Ashton',
                    budgets: { google: 5000, facebook: 3000 }
                },
                'Apollo - Bradford': {
                    campaigns: ['*'], // All campaigns
                    tabPrefix: 'Apollo Bradford',
                    budgets: { google: 4000, facebook: 2500 }
                },
                'Apollo - Blackpool': {
                    campaigns: ['*'], // All campaigns
                    tabPrefix: 'Apollo Blackpool',
                    budgets: { google: 3500, facebook: 2000 }
                },
                'HC-One - England/Wales': {
                    campaigns: [
                        'AL -  Always on Care Search Campaign',
                        'Always on Care',
                        'HC-One Always On Campaign'
                    ],
                    tabPrefix: 'HC1',
                    budgets: { google: 1000, facebook: 1500 }
                },
                'HC-One - Scotland': {
                    campaigns: [
                        'AL -  Always on Care Search Campaign',
                        'Always on Care',
                        'HC-One Always On Campaign'
                    ],
                    tabPrefix: 'HC2',
                    budgets: { google: 800, facebook: 1200 }
                }
            };

            const getDateRange = (range) => {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                switch (range) {
                    case 'today':
                        return { start: today, end: today };
                    case 'yesterday':
                        return { start: yesterday, end: yesterday };
                    case 'last7days':
                        const week = new Date(today);
                        week.setDate(week.getDate() - 7);
                        return { start: week, end: today };
                    case 'last30days':
                        const month = new Date(today);
                        month.setDate(month.getDate() - 30);
                        return { start: month, end: today };
                    default:
                        return { start: today, end: today };
                }
            };

            const isDateInRange = (dateStr, range) => {
                const date = new Date(dateStr);
                const { start, end } = getDateRange(range);
                return date >= start && date <= end;
            };

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        setLoading(true);
                        const response = await fetch('https://sheets-proxy-ria9.vercel.app/api/sheets');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const result = await response.json();
                        setData(result);
                    } catch (err) {
                        setError(err.message);
                        console.error('Error fetching data:', err);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, []);

            const processedClients = useMemo(() => {
                if (!data) return [];

                return Object.entries(clientConfig).map(([clientName, config]) => {
                    const { tabPrefix } = config;
                    let googleDaily = 0;
                    let facebookDaily = 0;

                    // Process Google Ads data
                    const googleTabName = `${tabPrefix} Google Ads`;
                    if (data[googleTabName]) {
                        data[googleTabName]
                            .filter(row => isDateInRange(row.Date, dateRange))
                            .forEach(row => {
                                const campaign = row.Campaign || '';
                                const matchesCampaign = config.campaigns.includes('*') || 
                                                     config.campaigns.some(c => campaign === c);
                                
                                if (matchesCampaign) {
                                    const cost = parseFloat(row.Cost) || 0;
                                    googleDaily += cost;
                                }
                            });
                    }

                    // Process Facebook data with TARGETED debugging for HC-One
                    const facebookTabName = `${tabPrefix} FB`;
                    if (data[facebookTabName]) {
                        const adsetBudgetMap = new Map();
                        
                        // Count Always on Care rows for debugging
                        if (clientName.includes('HC-One') && clientName.includes('England')) {
                            const alwaysOnCareRows = data[facebookTabName].filter(row => 
                                (row.Campaign || '').includes('Always on Care')
                            );
                            console.log(`ðŸ” HC-One E/W: Found ${alwaysOnCareRows.length} "Always on Care" rows`);
                            
                            // Show the last few rows
                            const lastRows = alwaysOnCareRows.slice(-3);
                            console.log('ðŸ” Last 3 "Always on Care" rows:', lastRows.map(row => ({
                                date: row.Date,
                                campaign: row.Campaign,
                                adset: row.AdsetName,
                                budget: row.DailyBudget
                            })));
                        }

                        data[facebookTabName].forEach(row => {
                            const rowDate = new Date(row.Date);
                            const campaign = row.Campaign || '';
                            const adsetName = row.AdsetName || '';
                            const costStr = row['Amount spent (GBP)'] || row.Cost || '';
                            const cost = parseFloat(costStr) || 0;
                            const rawBudget = parseFloat(row.DailyBudget) || 0;

                            // Enhanced debug for Always on Care only
                            if (clientName.includes('HC-One') && clientName.includes('England') && 
                                campaign.includes('Always on Care')) {
                                console.log(`ðŸ” ALWAYS ON CARE DEBUG: Date=${row.Date}, Raw="${row.DailyBudget}", Numeric=${rawBudget}, Type=${typeof row.DailyBudget}`);
                            }

                            // Check date range
                            if (!isDateInRange(row.Date, dateRange)) {
                                return;
                            }

                            // Check campaign matching
                            const matchesCampaign = config.campaigns.includes('*') || 
                                                  config.campaigns.some(c => campaign === c);

                            if (matchesCampaign && rawBudget > 0) {
                                // Enhanced budget conversion with debugging
                                let dailyBudget = 0;
                                if (rawBudget) {
                                    // Convert to number first
                                    const numericBudget = parseFloat(rawBudget);
                                    
                                    // Smart conversion: if > 100, assume pennies; if <= 100, assume pounds
                                    if (numericBudget > 100) {
                                        dailyBudget = numericBudget / 100; // Convert pennies to pounds
                                        if (clientName.includes('HC-One') && clientName.includes('England') && 
                                            campaign.includes('Always on Care')) {
                                            console.log(`ðŸ” ALWAYS ON CARE CONVERTED: Â£${dailyBudget} (Logic: penniesÃ·100)`);
                                        }
                                    } else {
                                        dailyBudget = numericBudget; // Already in pounds
                                        if (clientName.includes('HC-One') && clientName.includes('England') && 
                                            campaign.includes('Always on Care')) {
                                            console.log(`ðŸ” ALWAYS ON CARE CONVERTED: Â£${dailyBudget} (Logic: already pounds)`);
                                        }
                                    }
                                }

                                const adsetKey = `${campaign}_${adsetName}`;
                                adsetBudgetMap.set(adsetKey, dailyBudget);

                                // Debug for HC-One E/W
                                if (clientName.includes('HC-One') && clientName.includes('England')) {
                                    console.log(`âœ… HC-One E/W MATCHED: Campaign="${campaign}", Adset="${adsetName}", Raw=${rawBudget}, Converted=Â£${dailyBudget}`);
                                }
                            } else if (clientName.includes('HC-One') && clientName.includes('England') && rawBudget > 0) {
                                console.log(`âŒ HC-One E/W NOT MATCHED: Campaign="${campaign}", Budget=Â£${rawBudget/100}, Expected campaigns:`, config.campaigns);
                            }
                        });

                        // Sum all unique adset budgets
                        facebookDaily = Array.from(adsetBudgetMap.values()).reduce((sum, budget) => sum + budget, 0);
                        
                        // Final debug for HC-One E/W
                        if (clientName.includes('HC-One') && clientName.includes('England')) {
                            console.log(`ðŸŽ¯ HC-One E/W FINAL: Total Facebook budget = Â£${facebookDaily}/day from ${adsetBudgetMap.size} adsets`);
                            console.log(`ðŸŽ¯ Adset breakdown:`, Array.from(adsetBudgetMap.entries()));
                        }
                    }

                    const totalDaily = googleDaily + facebookDaily;
                    const monthlyBudget = (config.budgets.google || 0) + (config.budgets.facebook || 0);
                    const expectedDaily = monthlyBudget / 30;
                    const remaining = expectedDaily - totalDaily;

                    return {
                        name: clientName,
                        googleDaily,
                        facebookDaily,
                        totalDaily,
                        expectedDaily,
                        remaining,
                        monthlyBudget,
                        budgetUtilization: expectedDaily > 0 ? (totalDaily / expectedDaily) * 100 : 0
                    };
                });
            }, [data, dateRange]);

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-lg">Loading dashboard...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-red-600">Error: {error}</div>
                    </div>
                );
            }

            const chartData = processedClients.map(client => ({
                name: client.name.split(' - ')[0],
                google: client.googleDaily,
                facebook: client.facebookDaily,
                expected: client.expectedDaily
            }));

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="mb-8">
                            <h1 className="text-3xl font-bold text-gray-900 mb-4">Marketing Budget Dashboard</h1>
                            
                            <div className="flex gap-4 mb-6">
                                <select 
                                    value={dateRange} 
                                    onChange={(e) => setDateRange(e.target.value)}
                                    className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="today">Today</option>
                                    <option value="yesterday">Yesterday</option>
                                    <option value="last7days">Last 7 Days</option>
                                    <option value="last30days">Last 30 Days</option>
                                </select>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            {processedClients.map((client, index) => (
                                <div key={index} className="bg-white rounded-lg shadow-md p-6">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">{client.name}</h3>
                                    
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Google Ads</span>
                                            <span className="font-medium text-blue-600">Â£{client.googleDaily.toFixed(2)}</span>
                                        </div>
                                        
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Meta Ads</span>
                                            <span className="font-medium text-green-600">Â£{client.facebookDaily.toFixed(2)}</span>
                                        </div>
                                        
                                        <div className="border-t pt-3">
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm font-medium text-gray-700">Total Daily</span>
                                                <span className="font-bold text-gray-900">Â£{client.totalDaily.toFixed(2)}</span>
                                            </div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Expected Daily</span>
                                            <span className="font-medium text-gray-700">Â£{client.expectedDaily.toFixed(2)}</span>
                                        </div>
                                        
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Remaining</span>
                                            <span className={`font-semibold ${client.remaining > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                Â£{client.remaining.toFixed(2)}
                                            </span>
                                        </div>
                                        
                                        <div className="mt-4">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm text-gray-600">Budget Utilization</span>
                                                <span className="text-sm font-medium">{client.budgetUtilization.toFixed(1)}%</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2">
                                                <div 
                                                    className={`h-2 rounded-full ${
                                                        client.budgetUtilization > 100 ? 'bg-red-500' : 
                                                        client.budgetUtilization > 80 ? 'bg-yellow-500' : 'bg-green-500'
                                                    }`}
                                                    style={{ width: `${Math.min(client.budgetUtilization, 100)}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">Daily Spend by Platform</h3>
                                <ResponsiveContainer width="100%" height={300}>
                                    <BarChart data={chartData}>
                                        <CartesianGrid strokeDasharray="3 3" />
                                        <XAxis 
                                            dataKey="name" 
                                            tick={{ fontSize: 12 }}
                                            interval={0}
                                            angle={-45}
                                            textAnchor="end"
                                            height={60}
                                        />
                                        <YAxis tick={{ fontSize: 12 }} />
                                        <Tooltip formatter={(value) => [`Â£${Number(value).toFixed(2)}`, '']} />
                                        <Legend />
                                        <Bar dataKey="google" fill="#4285f4" name="Google Ads" />
                                        <Bar dataKey="facebook" fill="#1877f2" name="Meta Ads" />
                                        <Bar dataKey="expected" fill="#fbbf24" name="Expected Daily" />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>

                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">Budget Utilization Overview</h3>
                                <div className="space-y-4">
                                    {processedClients.map((client, index) => (
                                        <div key={index} className="flex items-center justify-between">
                                            <span className="text-sm font-medium text-gray-700 flex-1">
                                                {client.name.split(' - ')[0]}
                                            </span>
                                            <div className="flex items-center gap-3 flex-1">
                                                <div className="w-full bg-gray-200 rounded-full h-2">
                                                    <div 
                                                        className={`h-2 rounded-full ${
                                                            client.budgetUtilization > 100 ? 'bg-red-500' : 
                                                            client.budgetUtilization > 80 ? 'bg-yellow-500' : 'bg-green-500'
                                                        }`}
                                                        style={{ width: `${Math.min(client.budgetUtilization, 100)}%` }}
                                                    ></div>
                                                </div>
                                                <span className="text-sm font-medium text-gray-600 min-w-12">
                                                    {client.budgetUtilization.toFixed(0)}%
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<BudgetDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
