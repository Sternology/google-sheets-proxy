<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Budget Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; font-family: -apple-system, system-ui, sans-serif; }
        
        /* Transitions */
        .gauge-fill { transition: stroke-dashoffset 0.8s ease; }
        .transition-all { transition: all 0.3s ease; }
        
        /* Card Flip */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* Graph Animation */
        .draw-path {
            stroke-dasharray: 2000;
            stroke-dashoffset: 2000;
            animation: draw 2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        @keyframes draw { to { stroke-dashoffset: 0; } }
    </style>
</head>
<body class="p-6">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- HELPERS ---
        const formatMoney = (val) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(val);
        const formatNumber = (val) => new Intl.NumberFormat('en-GB').format(val);

        const normalize = (text) => {
            if (!text) return '';
            // Remove extra spaces to match "Conversion  2025" with "Conversion 2025"
            return text.toLowerCase().replace(/‚Äì/g, '-').replace(/‚Äî/g, '-').replace(/\|/g, '').replace(/\s+/g, ' ').trim();
        };

        const parseSheetDate = (dateStr) => {
            if (!dateStr) return null;
            const s = String(dateStr).trim();
            const iso = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
            if (iso) return new Date(iso[1], iso[2] - 1, iso[3]);
            const uk = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
            if (uk) return new Date(uk[3], uk[2] - 1, uk[1]);
            const d = new Date(s);
            return isNaN(d.getTime()) ? null : d;
        };

        const mapRow = (headers, row) => {
            const obj = { Date: null, Cost: 0, CTR: 0, DailyBudget: 0, CareApps: 0, NurseApps: 0, SupportApps: 0, Adset: '', Campaign: '', RawCare: 0, Clicks: 0, Impressions: 0 };
            
            // 1. Identify Column Indexes dynamically
            const idx = { date: -1, cost: -1, budget: -1, adset: -1, camp: -1, clicks: -1, imps: -1, care: -1, nurse: -1, support: -1, ctr: -1 };
            
            headers.forEach((h, i) => {
                const lower = (h || '').trim().toLowerCase();
                if (!lower) return;
                
                if (lower === 'date' || lower === 'day') idx.date = i;
                else if (lower.includes('adset name')) idx.adset = i;
                else if (lower.includes('campaign')) idx.camp = i;
                else if (lower.includes('amount spent') || lower === 'cost') idx.cost = i;
                else if (lower.includes('budget')) idx.budget = i;
                else if (lower === 'link clicks' || lower === 'clicks') idx.clicks = i;
                else if (lower === 'impressions' || lower === 'impr.') idx.imps = i;
                else if (lower.includes('ctr')) idx.ctr = i;
                else if (lower.includes('conversion') || lower.includes('application')) {
                    if (lower.includes('nurse')) idx.nurse = i;
                    else if (lower.includes('support')) idx.support = i;
                    else if (lower.includes('care')) idx.care = i;
                }
            });

            // 2. Extract Data
            if (idx.date > -1) obj.Date = parseSheetDate(row[idx.date]);
            if (idx.camp > -1) obj.Campaign = row[idx.camp];
            if (idx.adset > -1) obj.Adset = row[idx.adset]; // Now correctly found!

            const getNum = (i) => {
                if (i === -1 || !row[i]) return 0;
                const n = parseFloat(String(row[i]).replace(/[%¬£$,]/g, ''));
                return isNaN(n) ? 0 : n;
            };

            // Spend (Pence Check)
            const rawCost = getNum(idx.cost);
            const headerCost = idx.cost > -1 ? headers[idx.cost].toLowerCase() : '';
            if (rawCost > 500 && headerCost.includes('amount spent')) obj.Cost = rawCost / 100;
            else obj.Cost = rawCost;

            // Budget
            const rawBudget = getNum(idx.budget);
            if (rawBudget > 500 && idx.budget > -1 && headers[idx.budget].toLowerCase().includes('adset')) obj.DailyBudget = rawBudget / 100;
            else obj.DailyBudget = rawBudget;

            // Metrics
            obj.Clicks = getNum(idx.clicks);
            obj.Impressions = getNum(idx.imps);

            // Fallback CTR
            const rawCtr = getNum(idx.ctr);
            if (rawCtr <= 1) obj.CTR = rawCtr * 100; else obj.CTR = rawCtr;

            // Conversions (Anti-Inflation < 50)
            const getConv = (i) => {
                const n = getNum(i);
                return (n < 50) ? n : 0;
            };
            obj.CareApps = getConv(idx.care);
            obj.RawCare = getNum(idx.care);
            obj.NurseApps = getConv(idx.nurse);
            obj.SupportApps = getConv(idx.support);

            return obj;
        };

        // --- COMPONENTS ---
        const DebugPanel = ({ logs }) => {
            if (!logs || logs.length === 0) return null;
            return (
                <div className="mt-8 bg-slate-900 text-slate-200 p-6 rounded-xl overflow-hidden font-mono text-xs shadow-2xl border border-slate-700">
                    <h3 className="text-lg font-bold text-white mb-4 border-b border-slate-600 pb-2">Debug Analysis Log</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead>
                                <tr className="text-slate-500">
                                    <th className="pb-2">Client</th>
                                    <th className="pb-2">Date</th>
                                    <th className="pb-2">Campaign</th>
                                    <th className="pb-2 text-right">Spend</th>
                                    <th className="pb-2 text-right text-blue-400">Clicks</th>
                                    <th className="pb-2 text-right text-purple-400">Imps</th>
                                    <th className="pb-2 text-right text-orange-400">CTR (Calc)</th>
                                    <th className="pb-2 pl-4">Apps</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                                {logs.map((log, i) => (
                                    <tr key={i} className="hover:bg-slate-700">
                                        <td className="py-2 text-blue-400">{log.client}</td>
                                        <td className="py-2">{log.date}</td>
                                        <td className="py-2 opacity-80 truncate max-w-[200px]" title={log.camp}>{log.camp}</td>
                                        <td className="py-2 text-right text-emerald-400">{log.spend > 0 ? `¬£${log.spend.toFixed(2)}` : '-'}</td>
                                        <td className="py-2 text-right text-blue-400">{log.clicks || '-'}</td>
                                        <td className="py-2 text-right text-purple-400">{log.imps || '-'}</td>
                                        <td className="py-2 text-right text-orange-400 font-bold">
                                            {(log.clicks > 0 && log.imps > 0) ? `${((log.clicks/log.imps)*100).toFixed(2)}%` : '-'}
                                        </td>
                                        <td className="py-2 pl-4 text-white">{log.careApps > 0 ? log.careApps : '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const MonthSelector = ({ selectedMonth, onMonthChange, availableMonths }) => (
            <div className="flex items-center gap-3 bg-white p-2 rounded-lg border border-gray-200 shadow-sm">
                <label className="text-sm font-bold text-gray-600 pl-2">Period:</label>
                <select value={selectedMonth} onChange={(e) => onMonthChange(e.target.value)} className="bg-transparent text-sm font-medium text-gray-800 outline-none cursor-pointer pr-8">
                    {availableMonths.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}
                </select>
            </div>
        );

        const StaleDataAlert = ({ staleTabs }) => {
            if (!staleTabs || staleTabs.length === 0) return null;
            return (
                <div className="mb-6 bg-red-900/30 border border-red-500/50 rounded-xl p-4 flex items-start gap-3 animate-pulse text-white">
                    <span className="text-2xl">‚ö†Ô∏è</span>
                    <div>
                        <div className="text-red-400 font-bold text-sm uppercase tracking-wide mb-1">Data Freshness Warning</div>
                        <div className="text-red-100 text-sm">The following tabs have not updated with data for today:</div>
                        <div className="mt-2 flex flex-wrap gap-2">
                            {staleTabs.map(tab => (
                                <span key={tab} className="bg-red-900 text-red-200 px-2 py-1 rounded text-xs border border-red-700">{tab}</span>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const TrendChart = ({ dailyData }) => {
            const [expanded, setExpanded] = useState(false);
            const [visible, setVisible] = useState({ conv: true, cpa: true, ctr: true });
            const [hoverIndex, setHoverIndex] = useState(null);
            const containerRef = useRef(null);

            if (!dailyData || dailyData.length < 3) return null;

            const data = [...dailyData].sort((a,b) => a.date - b.date).slice(0, -1);
            
            const maxConv = Math.max(1, ...data.map(d => d.conv)) * 1.1;
            const maxCPA = Math.max(1, ...data.map(d => d.cpa)) * 1.1;
            const maxCTR = Math.max(1, ...data.map(d => d.ctr)) * 1.1;

            const width = 100;
            const height = 40;

            const getPath = (key, maxVal) => {
                return data.map((d, i) => {
                    const x = (i / (data.length - 1)) * width;
                    const val = d[key] || 0;
                    const y = height - (val / maxVal) * height;
                    return `${x},${y}`;
                }).join(" ");
            };

            const toggle = (key) => setVisible(prev => ({ ...prev, [key]: !prev[key] }));

            const handleMouseMove = (e) => {
                if (!containerRef.current) return;
                const rect = containerRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const index = Math.round((x / rect.width) * (data.length - 1));
                if (index >= 0 && index < data.length) setHoverIndex(index);
            };

            const activeData = hoverIndex !== null ? data[hoverIndex] : null;
            const activeX = hoverIndex !== null ? (hoverIndex / (data.length - 1)) * width : 0;
            const animKey = expanded ? 'open' : 'closed';

            return (
                <div className="mt-6 bg-slate-50 rounded-xl border border-slate-200 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <button 
                        onClick={() => setExpanded(!expanded)}
                        className="w-full flex items-center justify-between p-4 text-left bg-white hover:bg-slate-50 transition-colors"
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-xl">üìà</span>
                            <div>
                                <div className="text-sm font-bold text-slate-700 uppercase tracking-wide">Performance Trends</div>
                                <div className="text-xs text-slate-500">Click to view timeline (excluding today)</div>
                            </div>
                        </div>
                        <span className="text-slate-400 text-sm">{expanded ? 'Hide ‚ñ≤' : 'View ‚ñº'}</span>
                    </button>

                    <div className={`transition-all duration-500 ease-in-out overflow-hidden ${expanded ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}`}>
                        <div 
                            className="p-4 pt-0 relative" 
                            ref={containerRef}
                            onMouseMove={handleMouseMove}
                            onMouseLeave={() => setHoverIndex(null)}
                        >
                            {activeData && (
                                <div className="absolute z-20 bg-slate-900/95 text-white text-[10px] p-2 rounded shadow-xl pointer-events-none backdrop-blur-sm border border-slate-700"
                                     style={{ left: `${(hoverIndex / (data.length - 1)) * 100}%`, top: '10px', transform: hoverIndex > data.length/2 ? 'translateX(-105%)' : 'translateX(5%)' }}>
                                    <div className="font-bold mb-1 border-b border-slate-600 pb-1">{activeData.date.toLocaleDateString(undefined, {day:'numeric', month:'short'})}</div>
                                    <div className="space-y-1">
                                        {visible.conv && <div className="flex justify-between gap-3 text-emerald-400"><span>Conv:</span> <strong>{activeData.conv.toFixed(0)}</strong></div>}
                                        {visible.cpa && <div className="flex justify-between gap-3 text-blue-400"><span>CPA:</span> <strong>¬£{activeData.cpa.toFixed(2)}</strong></div>}
                                        {visible.ctr && <div className="flex justify-between gap-3 text-orange-400"><span>CTR:</span> <strong>{activeData.ctr.toFixed(2)}%</strong></div>}
                                    </div>
                                </div>
                            )}

                            <div className="relative mt-6 mx-2">
                                <div className="absolute -left-2 top-0 bottom-0 flex flex-col justify-between text-[8px] font-bold font-mono h-32 -translate-x-full text-right">
                                    <div className="flex flex-col gap-1">
                                        {visible.conv && <span className="text-emerald-600">{Math.round(maxConv/1.1)}</span>}
                                        {visible.cpa && <span className="text-blue-600">¬£{Math.round(maxCPA/1.1)}</span>}
                                    </div>
                                    <span className="text-slate-400">0</span>
                                </div>
                                <div className="absolute -right-2 top-0 bottom-0 flex flex-col justify-between text-[8px] font-bold font-mono h-32 translate-x-full text-left">
                                    <div className="flex flex-col gap-1">
                                        {visible.ctr && <span className="text-orange-500">{Math.round(maxCTR/1.1)}%</span>}
                                    </div>
                                    <span className="text-slate-400">0%</span>
                                </div>

                                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-32 overflow-visible cursor-crosshair">
                                    <line x1="0" y1={height} x2="100" y2={height} stroke="#cbd5e1" strokeWidth="0.5" />
                                    {expanded && (
                                        <g key={animKey}>
                                            {visible.conv && <polyline points={getPath('conv', maxConv)} fill="none" stroke="#10b981" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" className="draw-path" style={{animationDelay: '0.1s'}} />}
                                            {visible.cpa && <polyline points={getPath('cpa', maxCPA)} fill="none" stroke="#3b82f6" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" className="draw-path" style={{animationDelay: '0.3s'}} />}
                                            {visible.ctr && <polyline points={getPath('ctr', maxCTR)} fill="none" stroke="#f97316" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" className="draw-path" style={{animationDelay: '0.5s'}} />}
                                            {activeData && <line x1={activeX} y1="0" x2={activeX} y2={height} stroke="#64748b" strokeWidth="0.5" strokeDasharray="2" />}
                                        </g>
                                    )}
                                </svg>
                            </div>

                            <div className="flex justify-between text-[8px] text-gray-400 mt-2 font-mono uppercase">
                                <span>{data[0].date.toLocaleDateString(undefined, {day:'numeric', month:'short'})}</span>
                                <span>{data[data.length-1].date.toLocaleDateString(undefined, {day:'numeric', month:'short'})}</span>
                            </div>

                            <div className="flex justify-center gap-4 mt-3 border-t border-slate-100 pt-2">
                                <button onClick={() => toggle('conv')} className={`flex items-center text-[10px] font-bold uppercase transition-opacity ${visible.conv ? 'opacity-100' : 'opacity-40 grayscale'}`}>
                                    <div className="w-2 h-2 rounded-full bg-emerald-500 mr-1.5"></div><span className="text-emerald-600">Conv</span>
                                </button>
                                <button onClick={() => toggle('cpa')} className={`flex items-center text-[10px] font-bold uppercase transition-opacity ${visible.cpa ? 'opacity-100' : 'opacity-40 grayscale'}`}>
                                    <div className="w-2 h-2 rounded-full bg-blue-500 mr-1.5"></div><span className="text-blue-600">CPA</span>
                                </button>
                                <button onClick={() => toggle('ctr')} className={`flex items-center text-[10px] font-bold uppercase transition-opacity ${visible.ctr ? 'opacity-100' : 'opacity-40 grayscale'}`}>
                                    <div className="w-2 h-2 rounded-full bg-orange-500 mr-1.5"></div><span className="text-orange-500">CTR</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const KPICard = ({ label, value, icon, color, trend, prevValue, details }) => {
            const [flipped, setFlipped] = useState(false);
            const theme = {
                green: "bg-emerald-50 text-emerald-700 border-emerald-200",
                blue: "bg-blue-50 text-blue-700 border-blue-200",
                orange: "bg-orange-50 text-orange-700 border-orange-200"
            }[color] || "bg-gray-50 text-gray-700";

            let trendColor = "bg-gray-100 text-gray-600";
            let arrow = "‚Üí";
            
            if (trend !== undefined && trend !== null && !isNaN(trend) && isFinite(trend)) {
                const isPositive = trend > 0;
                arrow = isPositive ? "‚Üë" : "‚Üì";
                const isCPA = label.includes('CPA') || label.includes('Cost');
                if (isCPA) trendColor = isPositive ? "bg-red-100 text-red-700" : "bg-emerald-100 text-emerald-700";
                else trendColor = isPositive ? "bg-emerald-100 text-emerald-700" : "bg-red-100 text-red-700";
            }
            
            return (
                <div className="perspective-1000 h-32 cursor-pointer group" onClick={() => setFlipped(!flipped)}>
                    <div className={`relative w-full h-full transition-transform duration-500 transform-style-3d ${flipped ? 'rotate-y-180' : ''}`}>
                        {/* FRONT */}
                        <div className={`absolute w-full h-full backface-hidden p-4 rounded-xl border ${theme} flex flex-col justify-between shadow-sm group-hover:shadow-md`}>
                            <div>
                                <div className="flex items-center gap-2 opacity-90 mb-1">
                                    <span className="text-xl">{icon}</span>
                                    <span className="text-xs font-bold uppercase tracking-wider">{label}</span>
                                </div>
                                <div className="text-2xl font-bold">{value}</div>
                            </div>
                            
                            {trend !== undefined && !isNaN(trend) && isFinite(trend) && (
                                <div className={`w-full py-1.5 px-2 rounded text-xs font-bold flex items-center justify-between ${trendColor}`}>
                                    <span className="flex items-center gap-1">{arrow} {Math.abs(trend).toFixed(0)}%</span>
                                    <span className="opacity-60 font-normal">vs prev</span>
                                </div>
                            )}
                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-40 transition-opacity text-[10px]">‚Üª</div>
                        </div>

                        {/* BACK */}
                        <div className="absolute w-full h-full backface-hidden rotate-y-180 p-4 rounded-xl border bg-white border-gray-200 flex flex-col justify-center shadow-sm">
                            <div className="text-xs font-bold uppercase text-gray-400 mb-2 text-center">{label} Split</div>
                            <div className="grid grid-cols-2 gap-2 text-center">
                                <div className="bg-orange-50 p-2 rounded border border-orange-100">
                                    <div className="text-[10px] font-bold text-orange-600 uppercase">Google</div>
                                    <div className="font-bold text-gray-800 text-sm">{details?.google || '-'}</div>
                                </div>
                                <div className="bg-blue-50 p-2 rounded border border-blue-100">
                                    <div className="text-[10px] font-bold text-blue-600 uppercase">Meta</div>
                                    <div className="font-bold text-gray-800 text-sm">{details?.facebook || '-'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Gauge = ({ pct, label, sub, color, detail }) => {
            const r = 40, c = 2 * Math.PI * r;
            const off = c - (Math.min(pct, 100) / 100) * c;
            return (
                <div className="flex flex-col items-center justify-center relative">
                    <div className="text-xs font-bold text-gray-400 uppercase mb-2">{label}</div>
                    <div className="relative flex items-center justify-center">
                        <svg width="96" height="96" className="-rotate-90 transform">
                            <circle cx="48" cy="48" r={r} stroke="#e2e8f0" strokeWidth="8" fill="none" />
                            <circle cx="48" cy="48" r={r} stroke={color} strokeWidth="8" fill="none" strokeLinecap="round"
                                style={{ strokeDasharray: c, strokeDashoffset: off }} className="gauge-fill" />
                        </svg>
                        <div className="absolute font-bold text-gray-700 text-lg">{sub}</div>
                    </div>
                    {detail && (
                        <div className="text-[10px] text-gray-500 mt-1 font-medium bg-gray-100 px-2 py-1 rounded-full">
                            {detail}
                        </div>
                    )}
                </div>
            );
        };

        const BudgetAction = ({ client }) => {
            const [open, setOpen] = useState(false);

            if (client.isHistorical) {
                const diff = client.budget - client.total;
                const under = diff >= 0;
                return (
                    <div className={`mt-6 p-4 rounded-xl border flex justify-between items-center ${under ? 'bg-blue-50 border-blue-200 text-blue-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                        <span className="font-bold">{under ? 'Under Budget' : 'Over Budget'}</span>
                        <span className="font-mono font-bold text-lg">{under ? '-' : '+'}{formatMoney(Math.abs(diff))}</span>
                    </div>
                );
            }

            const remaining = client.budget - client.total;
            const target = Math.max(0, remaining / client.daysLeft);
            const current = client.currentDailyBudget;
            const change = target - current;
            
            let status = 'normal';
            if (client.total >= client.budget) status = 'critical';
            else if (Math.abs(change) < 3) status = 'optimal';
            else if (change > 0) status = 'increase';
            else status = 'decrease';

            const style = {
                critical: "bg-red-50 border-red-200 text-red-900",
                increase: "bg-indigo-50 border-indigo-200 text-indigo-900",
                decrease: "bg-amber-50 border-amber-200 text-amber-900",
                optimal: "bg-emerald-50 border-emerald-200 text-emerald-900",
                normal: "bg-gray-50 border-gray-200 text-gray-900"
            }[status];

            const msg = {
                critical: "Budget Exhausted",
                increase: "Increase Daily Spend",
                decrease: "Reduce Daily Spend",
                optimal: "Spend is Optimal",
                normal: "Adjust Spend"
            }[status];

            let gRec = 0, fRec = 0;
            const totalCur = client.googleDailyBudget + client.facebookDailyBudget;
            if (client.name.includes('Brandon')) { fRec = target; }
            else if (totalCur > 0) {
                const ratio = client.googleDailyBudget / totalCur;
                gRec = target * ratio; fRec = target * (1 - ratio);
            } else { gRec = target / 2; fRec = target / 2; }

            return (
                <div className={`mt-6 rounded-xl border overflow-hidden transition-all duration-300 ${style} shadow-sm hover:shadow-md cursor-pointer`} onClick={() => setOpen(!open)}>
                    <div className="p-5 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">{status === 'critical' ? 'üö®' : status === 'optimal' ? '‚úÖ' : '‚öôÔ∏è'}</span>
                            <div>
                                <div className="text-[10px] uppercase opacity-60 font-bold tracking-wide">Recommendation</div>
                                <div className="font-bold text-sm">{msg}</div>
                            </div>
                        </div>
                        <span className="text-xl opacity-50">{open ? '‚àí' : '+'}</span>
                    </div>

                    <div className={`overflow-hidden transition-all duration-300 ${open ? 'max-h-48 opacity-100 border-t border-black/5' : 'max-h-0 opacity-0'}`}>
                        <div className="p-5 pt-2 grid grid-cols-2 gap-6 text-sm bg-white/50">
                            <div>
                                <div className="text-xs uppercase opacity-60 mb-1 font-semibold">Daily Target</div>
                                <div className="flex justify-between mb-1"><span>Current</span><span className="font-mono">{formatMoney(current)}</span></div>
                                <div className="flex justify-between font-bold"><span>Target</span><span className="font-mono">{formatMoney(target)}</span></div>
                                <div className="mt-2 pt-2 border-t border-black/10 flex justify-between font-bold text-xs">
                                    <span>Change</span><span>{change > 0 ? '+' : ''}{formatMoney(change)}</span>
                                </div>
                            </div>
                            <div>
                                <div className="text-xs uppercase opacity-60 mb-1 font-semibold">Platform Split</div>
                                {gRec > 0 && <div className="flex justify-between mb-1"><span>Google</span><span className="font-mono">{formatMoney(gRec)}</span></div>}
                                {fRec > 0 && <div className="flex justify-between"><span>Meta</span><span className="font-mono">{formatMoney(fRec)}</span></div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ClientCard = ({ client }) => {
            const [open, setOpen] = useState(false);
            
            let kpi = { lbl: 'Conversions', val: client.conversions, icon: 'üéØ', prev: client.prev.conversions };
            if (client.name.includes('Nursing')) kpi = { lbl: 'Nurse Apps', val: client.nursingConversions, icon: 'üë©‚Äç‚öïÔ∏è', prev: client.prev.nursingConversions };
            else if (client.name.includes('Brandon')) kpi = { lbl: 'Support Apps', val: client.supportConversions + client.careConversions, icon: 'üìù', prev: client.prev.supportConversions + client.prev.careConversions };
            else if (client.name.includes('Care') || client.name.includes('HC-One')) kpi = { lbl: 'Care Apps', val: client.careConversions, icon: 'üè•', prev: client.prev.careConversions };

            const calcTrend = (curr, prev) => prev > 0 ? ((curr - prev) / prev) * 100 : 0;
            const convTrend = calcTrend(kpi.val, kpi.prev);
            const cpa = kpi.val > 0 ? client.total / kpi.val : 0;
            const prevCpa = kpi.prev > 0 ? client.prev.total / kpi.prev : 0;
            const cpaTrend = calcTrend(cpa, prevCpa);
            const ctrTrend = calcTrend(client.ctr, client.prev.ctr);

            // Split Calcs for Flip Cards
            let gVal = 0, fVal = 0;
            if(client.name.includes('Nursing')){ gVal=client.gNurse; fVal=client.fNurse; }
            else if(client.name.includes('Brandon')){ gVal=client.gSupport; fVal=client.fSupport; }
            else { gVal=client.gCare; fVal=client.fCare; }

            const gCpa = gVal > 0 ? client.google / gVal : 0;
            const fCpa = fVal > 0 ? client.facebook / fVal : 0;
            const gCtr = client.gCtrCount > 0 ? (client.gCtrSum/client.gCtrCount)*100 : 0;
            const fCtr = client.fCtrCount > 0 ? (client.fCtrSum/client.fCtrCount)*100 : 0;

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col h-full">
                    <div className="flex justify-between items-start mb-6">
                        <div>
                            <h3 className="font-bold text-lg text-gray-900">{client.name}</h3>
                            <div className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">{client.periodLabel}</div>
                        </div>
                        <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${
                            client.status === 'HOT' ? 'bg-red-100 text-red-700' : 
                            client.status === 'COLD' ? 'bg-blue-100 text-blue-700' : 'bg-emerald-100 text-emerald-700'
                        }`}>{client.status}</span>
                    </div>

                    <div className="grid grid-cols-3 gap-2 mb-6">
                        <Gauge pct={client.pctUsed} label="Budget" sub={`${client.pctUsed.toFixed(0)}%`} color={client.pctUsed > 100 ? '#ef4444' : '#10b981'} detail={`${formatMoney(client.total)} / ${formatMoney(client.budget)}`} />
                        <div className="flex flex-col items-center justify-center p-2 bg-gray-50 rounded-xl border border-gray-100">
                            <div className="text-xs font-bold text-gray-400 uppercase mb-2">Pace</div>
                            <div className="text-3xl">{client.status === 'HOT' ? 'üî•' : client.status === 'COLD' ? 'üßä' : '‚úÖ'}</div>
                        </div>
                        <Gauge pct={(client.projected/client.budget)*100} label="Projected" sub={formatMoney(client.projected)} color="#3b82f6" />
                    </div>

                    <div className="grid grid-cols-3 gap-3">
                        <KPICard label={kpi.lbl} value={formatNumber(Math.floor(kpi.val))} icon={kpi.icon} color="green" trend={convTrend} prevValue={Math.floor(kpi.prev)} details={{ google: Math.floor(gVal), facebook: Math.floor(fVal) }} />
                        <KPICard label="CPA" value={cpa ? `¬£${cpa.toFixed(2)}` : '-'} icon="üí∞" color="blue" trend={cpaTrend} prevValue={prevCpa ? `¬£${prevCpa.toFixed(2)}` : null} details={{ google: gCpa ? `¬£${gCpa.toFixed(2)}` : '-', facebook: fCpa ? `¬£${fCpa.toFixed(2)}` : '-' }} />
                        <KPICard label="CTR" value={`${client.ctr.toFixed(2)}%`} icon="üëÜ" color="orange" trend={ctrTrend} prevValue={client.prev.ctr > 0 ? `${client.prev.ctr.toFixed(2)}%` : null} details={{ google: `${gCtr.toFixed(2)}%`, facebook: `${fCtr.toFixed(2)}%` }} />
                    </div>
                    
                    <TrendChart dailyData={client.dailyData} />

                    <BudgetAction client={client} />

                    <div className="mt-auto pt-4 border-t border-gray-100">
                        <button onClick={() => setOpen(!open)} className="w-full flex justify-between text-xs font-bold uppercase text-gray-400 hover:text-gray-600 tracking-wider">
                            <span>Details</span><span>{open ? 'Hide' : 'Show'}</span>
                        </button>
                        {open && (
                            <div className="mt-3 space-y-2 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl border border-gray-100 animate-fade-in">
                                <div className="flex justify-between"><span>Spent</span><strong>{formatMoney(client.total)}</strong></div>
                                <div className="flex justify-between"><span>Budget</span><strong>{formatMoney(client.budget)}</strong></div>
                                <div className="flex justify-between"><span>Daily (Actual)</span><strong>{formatMoney(client.currentDailyBudget)}</strong></div>
                                <div className="flex justify-between"><span>Days Left</span><strong>{client.daysLeft}</strong></div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Dashboard = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [month, setMonth] = useState('current');
            const [latestDataDate, setLatestDataDate] = useState(null);
            const [debug, setDebug] = useState(false);
            const [debugLogs, setDebugLogs] = useState([]);
            const [staleTabs, setStaleTabs] = useState([]);
            
            const PROXY = 'https://sheets-proxy-ria9.vercel.app/api/sheets-proxy';
            const SHEET = '1nbVrRxhIh2RLa5qtOsaM1N_UmqljztVwxPbQRCnkBcs';
            const KEY = 'AIzaSyDffl5VtZDXxAMJ-Cnbay7CbO-PPfF42fI';

            const getDates = (type, sel) => {
                const now = latestDataDate ? new Date(latestDataDate) : new Date();
                if (sel === 'last30') {
                    const end = now;
                    const start = new Date(now); start.setDate(now.getDate() - 30);
                    const prevEnd = new Date(start); prevEnd.setDate(start.getDate() - 1);
                    const prevStart = new Date(prevEnd); prevStart.setDate(prevEnd.getDate() - 30);
                    return { start, end, prevStart, prevEnd };
                }
                let y = now.getFullYear(), m = now.getMonth();
                if (sel !== 'current') {
                    const parts = sel.split('-');
                    y = parseInt(parts[0]); m = parseInt(parts[1]) - 1;
                }
                const make = (d) => new Date(y, m, d);
                const makePrev = (d) => new Date(y, m - 1, d);
                let cur = {};
                if (type === 'apollo') cur = (sel === 'current' && now.getDate() >= 26) ? { start: make(26), end: new Date(y, m+1, 25) } : { start: makePrev(26), end: make(25) };
                else if (type === 'brandon') cur = (sel === 'current' && now.getDate() >= 21) ? { start: make(21), end: new Date(y, m+1, 20) } : { start: makePrev(21), end: make(20) };
                else if (type === 'hc1') cur = (sel === 'current' && now.getDate() >= 11) ? { start: make(11), end: new Date(y, m+1, 10) } : { start: makePrev(11), end: make(10) };
                else cur = { start: new Date(y, m, 1), end: new Date(y, m+1, 0) };
                
                let prevEnd = new Date(cur.end); prevEnd.setMonth(prevEnd.getMonth() - 1);
                const prevStart = new Date(cur.start); prevStart.setMonth(prevStart.getMonth() - 1);
                if (sel === 'current') {
                    const msPassed = now - cur.start;
                    prevEnd = new Date(prevStart.getTime() + msPassed);
                }
                return { ...cur, prevStart, prevEnd };
            };

            const load = async () => {
                setLoading(true);
                setDebugLogs([]);
                try {
                    const cfgRes = await fetch(`${PROXY}?spreadsheetId=${SHEET}&range=Config!A:F&apiKey=${KEY}`);
                    const cfgJson = await cfgRes.json();
                    const clients = cfgJson.values.slice(1).map(r => ({
                        name: r[0], budget: parseFloat(r[1].replace(/,/g, '')), type: r[2], prefix: r[3] || r[0], 
                        skip: r[4] === 'TRUE', 
                        camps: r[5] ? r[5].split(',').map(c => c.trim()).filter(c => c.length > 0) : []
                    }));

                    const prefixes = [...new Set(clients.map(c => c.prefix))];
                    const cache = {};
                    let maxTs = 0;
                    
                    const tabsChecked = new Set();
                    const stale = new Set();

                    await Promise.all(prefixes.map(async prefix => {
                        const fetchRange = async (suffix) => {
                            try {
                                const tabName = `${prefix} ${suffix}`;
                                if (tabsChecked.has(tabName)) return;
                                tabsChecked.add(tabName);
                                
                                const range = (prefix + ' ' + suffix).includes('FB') ? `${tabName}!A:H` : `${tabName}!A:F`;
                                const res = await fetch(`${PROXY}?spreadsheetId=${SHEET}&range=${encodeURIComponent(range)}&apiKey=${KEY}`);
                                const json = await res.json();
                                if (json.values) {
                                    cache[tabName] = json.values;
                                    const lastDate = parseSheetDate(json.values[json.values.length-1][0]);
                                    if (lastDate) {
                                        const now = new Date();
                                        if ((now - lastDate) / (1000 * 60 * 60 * 24) > 1.5) stale.add(tabName);
                                    }
                                }
                            } catch(e) {}
                        };
                        const fetchConv = async () => {
                            try {
                                const tabName = `${prefix} Google Conversions`;
                                const res = await fetch(`${PROXY}?spreadsheetId=${SHEET}&range=${encodeURIComponent(prefix + ' Google Conversions!A:E')}&apiKey=${KEY}`);
                                const json = await res.json();
                                if (json.values) cache[tabName] = json.values;
                            } catch(e) {}
                        };
                        await Promise.all([fetchRange('Google'), fetchRange('FB'), fetchConv()]);
                    }));
                    
                    setStaleTabs(Array.from(stale));

                    Object.values(cache).forEach(rows => {
                        if (!rows || rows.length < 2) return;
                        const h = rows[0];
                        rows.slice(1).forEach(r => {
                            const d = mapRow(h, r);
                            if (d.Date && d.Date.getTime() > maxTs) maxTs = d.Date.getTime();
                        });
                    });
                    if (maxTs > 0) setLatestDataDate(new Date(maxTs));

                    const tempLogs = [];

                    const results = clients.map(client => {
                        const currentRef = maxTs > 0 ? new Date(maxTs) : new Date();
                        const dates = getDates(client.type, month);
                        const label = `${dates.start.toLocaleDateString('en-GB')} - ${dates.end.toLocaleDateString('en-GB')}`;
                        
                        let g = { spend:0, care:0, nurse:0, support:0, ctrSum:0, ctrCount:0 };
                        let f = { spend:0, care:0, nurse:0, support:0, ctrSum:0, ctrCount:0 };
                        let prev = { total: 0, conversions:0, cpa:0, ctr:0, careConversions:0, nursingConversions:0, supportConversions:0, ctrSum:0, ctrCount:0 };

                        let gBudgets = new Map(), fBudgets = new Map();
                        let maxDateG = 0, maxDateF = 0;
                        
                        const dailyMap = new Map();
                        let iter = new Date(dates.start);
                        const endLimit = (month === 'current' || month === 'last30') ? currentRef : dates.end;
                        
                        while (iter <= endLimit) {
                            const key = iter.toISOString().split('T')[0];
                            dailyMap.set(key, { date: new Date(iter), cost: 0, conv: 0, ctrSum: 0, ctrCount: 0 });
                            iter.setDate(iter.getDate() + 1);
                        }

                        const processTab = (tabName, isConv = false) => {
                            const rows = cache[tabName];
                            if (!rows) return;
                            const h = rows[0];
                            rows.slice(1).forEach(r => {
                                const d = mapRow(h, r);
                                if (!d.Date) return;
                                
                                const rowText = normalize(d.Campaign + ' ' + d.Adset);
                                const match = client.camps.includes('*') || client.camps.some(c => rowText.includes(normalize(c)));
                                if (!match) return;

                                if (client.name.includes('England/Wales')) {
                                    const regions = ['Midlands', 'North East', 'North West', 'Scotland', 'South', 'Yorkshire', 'Humber'];
                                    if (regions.some(reg => rowText.includes(normalize(reg)))) return;
                                }

                                const inCurrent = d.Date >= dates.start && d.Date <= dates.end;
                                
                                if (inCurrent) {
                                    if (d.Cost > 0 || d.CareApps > 0 || d.NurseApps > 0 || d.RawCare > 0) {
                                        tempLogs.push({
                                            client: client.name, tab: tabName, date: d.Date.toLocaleDateString('en-GB'),
                                            camp: d.Campaign || d.Adset, spend: d.Cost, careApps: d.CareApps, rawCare: d.RawCare, ctr: d.CTR, clicks: d.Clicks, imps: d.Impressions,
                                            note: isConv ? 'Conv Tab' : d.RawCare > 50 ? 'High Val Ignored' : 'Matched'
                                        });
                                    }

                                    const dateKey = d.Date.toISOString().split('T')[0];
                                    if (dailyMap.has(dateKey)) {
                                        const day = dailyMap.get(dateKey);
                                        if (isConv) {
                                            const c = d.CareApps + d.NurseApps;
                                            day.conv += c;
                                            const target = tabName.includes('Google') ? g : f;
                                            target.care += d.CareApps; target.nurse += d.NurseApps;
                                        } else {
                                            day.cost += d.Cost;
                                            // Daily CTR using Clicks/Imps
                                            if (d.Clicks > 0 && d.Impressions > 0) {
                                                day.ctrSum += d.Clicks;
                                                day.ctrCount += d.Impressions;
                                            }
                                            const c = d.CareApps + d.NurseApps + d.SupportApps;
                                            day.conv += c;

                                            const target = tabName.includes('Google') ? g : f;
                                            target.spend += d.Cost;
                                            // Platform Totals
                                            if (d.Clicks > 0 && d.Impressions > 0) {
                                                target.ctrSum += d.Clicks;
                                                target.ctrCount += d.Impressions;
                                            }
                                            target.care += d.CareApps; target.nurse += d.NurseApps; target.support += d.SupportApps;
                                        }
                                    }
                                }

                                if (d.Date >= dates.prevStart && d.Date <= dates.prevEnd) {
                                    if (isConv) { prev.careConversions += d.CareApps; prev.nursingConversions += d.NurseApps; }
                                    else {
                                        prev.total += d.Cost;
                                        if (d.Clicks > 0 && d.Impressions > 0) { 
                                            prev.ctrSum += d.Clicks; 
                                            prev.ctrCount += d.Impressions; 
                                        }
                                        prev.careConversions += d.CareApps; prev.nursingConversions += d.NurseApps; prev.supportConversions += d.SupportApps;
                                    }
                                }

                                if (d.DailyBudget > 0 && !isConv) {
                                    const t = d.Date.getTime();
                                    if (tabName.includes('Google')) {
                                        if (t > maxDateG) { maxDateG = t; gBudgets.clear(); }
                                        if (t === maxDateG) gBudgets.set(normalize(d.Campaign)||'def', d.DailyBudget);
                                    } else {
                                        if (t > maxDateF) { maxDateF = t; fBudgets.clear(); }
                                        if (t === maxDateF) fBudgets.set(normalize(d.Adset)||'def', d.DailyBudget);
                                    }
                                }
                            });
                        };

                        processTab(`${client.prefix} Google`);
                        processTab(`${client.prefix} FB`);
                        processTab(`${client.prefix} Google Conversions`, true);

                        const dailyData = Array.from(dailyMap.values()).map(d => ({
                            date: d.date,
                            conv: d.conv,
                            cpa: d.conv > 0 ? d.cost / d.conv : 0,
                            // DAILY CTR = (Total Clicks / Total Imps) * 100
                            ctr: d.ctrCount > 0 ? (d.ctrSum / d.ctrCount) * 100 : 0
                        }));

                        let gDaily = 0, fDaily = 0;
                        gBudgets.forEach(v => gDaily += v);
                        fBudgets.forEach(v => fDaily += v);

                        const today = currentRef;
                        const daysTotal = Math.ceil((dates.end - dates.start) / 86400000);
                        const passed = Math.max(1, Math.min(daysTotal, Math.ceil((today - dates.start) / 86400000)));
                        const left = Math.max(0, daysTotal - passed);
                        
                        const totalSpend = g.spend + f.spend;
                        const avg = passed > 0 ? totalSpend / passed : 0;
                        const proj = totalSpend + (avg * left);
                        
                        let status = 'ON TRACK';
                        if (proj > client.budget * 1.05) status = 'HOT';
                        else if (proj < client.budget * 0.95) status = 'COLD';
                        if (totalSpend >= client.budget) status = 'OVER BUDGET';

                        prev.conversions = prev.careConversions + prev.nursingConversions + prev.supportConversions;
                        prev.cpa = prev.conversions > 0 ? prev.total / prev.conversions : 0;
                        // PREV CTR = (Total Clicks / Total Imps) * 100
                        prev.ctr = prev.ctrCount > 0 ? (prev.ctrSum / prev.ctrCount) * 100 : 0;

                        return {
                            ...client, 
                            periodLabel: label, daysLeft: left, projected: proj, pctUsed: (totalSpend/client.budget)*100, status,
                            currentDailyBudget: gDaily + fDaily,
                            googleDailyBudget: gDaily, facebookDailyBudget: fDaily,
                            
                            google: g.spend, facebook: f.spend,
                            gCare: g.care, fCare: f.care,
                            gNurse: g.nurse, fNurse: f.nurse,
                            gSupport: g.support, fSupport: f.support,
                            
                            // TOTAL AGGREGATE CTR = (Sum Clicks / Sum Imps) * 100
                            ctr: (g.ctrCount + f.ctrCount) > 0 ? ((g.ctrSum + f.ctrSum) / (g.ctrCount + f.ctrCount)) * 100 : 0,
                            
                            isHistorical: month !== 'current' && month !== 'last30',
                            prev: prev,
                            dailyData: dailyData
                        };
                    });
                    
                    setDebugLogs(tempLogs);
                    setData(results);
                } catch(e) { console.error(e); }
                setLoading(false);
            };

            useEffect(() => { load(); }, [month]);

            const months = [
                {value:'current', label:'Current Period'}, 
                {value:'last30', label:'Last 30 Days'},
                {value:'2025-11', label:'Nov 2025'}, 
                {value:'2025-10', label:'Oct 2025'}
            ];

            return (
                <div className="max-w-7xl mx-auto">
                    <div className="mb-6">
                        <StaleDataAlert staleTabs={staleTabs} />
                    </div>

                    <div className="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
                        <h1 className="text-3xl font-bold text-gray-800 tracking-tight text-white">Client Budgets</h1>
                        <div className="flex gap-4">
                            <button onClick={() => setDebug(!debug)} className={`px-4 py-2 rounded-lg text-sm font-bold border transition-colors ${debug ? 'bg-red-600 text-white border-red-600' : 'bg-slate-800 text-gray-300 border-slate-700 hover:bg-slate-700'}`}>
                                {debug ? 'Debug ON' : 'Debug OFF'}
                            </button>
                            <MonthSelector selectedMonth={month} onMonthChange={setMonth} availableMonths={months} />
                            <button onClick={load} className="bg-blue-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-500 transition-colors shadow-sm">Refresh</button>
                        </div>
                    </div>
                    
                    {loading && <div className="flex justify-center py-20"><div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div>}
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
                        {data.map(c => <ClientCard key={c.name} client={c} />)}
                    </div>

                    {debug && <DebugPanel logs={debugLogs} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
