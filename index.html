<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Budget Performance Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .gauge-chart {
            position: relative;
            width: 120px;
            height: 120px;
        }
        .gauge-svg {
            transform: rotate(-90deg);
        }
        .gauge-bg {
            fill: none;
            stroke: #f3f4f6;
            stroke-width: 15;
        }
        .gauge-fill {
            fill: none;
            stroke-width: 15;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }
        .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
        .collapsible-content.expanded {
            max-height: 800px;
            opacity: 1;
        }
        
        .chevron {
            transition: transform 0.3s ease;
        }
        .chevron.rotated {
            transform: rotate(180deg);
        }
        
        .kpi-badge {
            position: relative;
            overflow: hidden;
        }
        .kpi-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: currentColor;
            opacity: 0.3;
        }
        
        @keyframes pulseGreen {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        @keyframes pulseRed {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .trend-positive {
            animation: pulseGreen 2s infinite;
        }
        
        .trend-negative {
            animation: pulseRed 2s infinite;
        }
        
        .trend-arrow {
            display: inline-block;
            transition: transform 0.2s ease;
            font-weight: bold;
        }
        
        .trend-arrow.up {
            transform: translateY(-1px);
        }
        
        .trend-arrow.down {
            transform: translateY(1px);
        }
        
        .kpi-badge.trend-up {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.1) 100%);
        }
        
        .kpi-badge.trend-down {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.1) 100%);
        }
        
        .historical-badge {
            background: linear-gradient(135deg, rgba(156, 163, 175, 0.1) 0%, rgba(156, 163, 175, 0.2) 100%);
            border: 2px solid rgba(156, 163, 175, 0.3);
        }
        
        .hit-target {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.2) 100%);
            border-color: rgba(16, 185, 129, 0.4);
        }
        
        .missed-target {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.2) 100%);
            border-color: rgba(239, 68, 68, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;
        
        const MonthSelector = ({ selectedMonth, onMonthChange, availableMonths }) => {
            return (
                <div className="flex items-center gap-3">
                    <label className="text-sm font-medium text-gray-700">View Period:</label>
                    <select
                        value={selectedMonth}
                        onChange={(e) => onMonthChange(e.target.value)}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                    >
                        {availableMonths.map(month => (
                            <option key={month.value} value={month.value}>
                                {month.label} {month.isCurrent ? '(Current)' : ''}
                            </option>
                        ))}
                    </select>
                    {selectedMonth !== 'current' && (
                        <span className="text-xs text-gray-500 italic">
                            Viewing historical data
                        </span>
                    )}
                </div>
            );
        };
        
        const KPIScorecard = ({ label, value, unit, trend, performance, icon, invertTrend = false, previousValue = null }) => {
            const getPerformanceColor = () => {
                switch(performance) {
                    case 'excellent': return 'text-green-600 bg-green-50 border-green-200';
                    case 'good': return 'text-blue-600 bg-blue-50 border-blue-200';
                    case 'average': return 'text-yellow-600 bg-yellow-50 border-yellow-200';
                    case 'poor': return 'text-red-600 bg-red-50 border-red-200';
                    default: return 'text-gray-600 bg-gray-50 border-gray-200';
                }
            };

            const getTrendColor = () => {
                if (trend === null || trend === undefined || trend === 0) return 'text-gray-400';
                
                const isPositiveTrend = invertTrend ? trend < 0 : trend > 0;
                return isPositiveTrend ? 'text-green-600 trend-positive' : 'text-red-600 trend-negative';
            };

            const getTrendIcon = () => {
                if (trend === null || trend === undefined || trend === 0) return '‚Üí';
                return trend > 0 ? '‚Üë' : '‚Üì';
            };
            
            const getTrendClass = () => {
                if (trend === null || trend === undefined || trend === 0) return '';
                const isPositiveTrend = invertTrend ? trend < 0 : trend > 0;
                return isPositiveTrend ? 'trend-up' : 'trend-down';
            };

            const formatTrend = () => {
                if (trend === null || trend === undefined) return null;
                return Math.abs(trend).toFixed(0);
            };

            return (
                <div className={`kpi-badge p-3 rounded-lg border ${getPerformanceColor()} transition-all hover:shadow-md ${getTrendClass()}`}>
                    <div className="flex items-start justify-between mb-1">
                        <div className="flex items-center">
                            <span className="text-lg mr-2">{icon}</span>
                            <div className="text-xs font-medium opacity-75">{label}</div>
                        </div>
                        {trend !== null && trend !== undefined && (
                            <span className={`text-sm font-bold ${getTrendColor()}`} title={previousValue ? `Previous: ${previousValue}` : ''}>
                                <span className={`trend-arrow ${trend > 0 ? 'up' : trend < 0 ? 'down' : ''}`}>
                                    {getTrendIcon()}
                                </span>
                                {formatTrend()}%
                            </span>
                        )}
                    </div>
                    <div className="flex items-baseline">
                        <span className="text-xl font-bold">{value}</span>
                        {unit && <span className="text-xs ml-1 opacity-75">{unit}</span>}
                    </div>
                    {previousValue && (
                        <div className="text-xs opacity-60 mt-1">
                            vs {previousValue} prev period
                        </div>
                    )}
                </div>
            );
        };
        
        const GaugeChart = ({ value, maxValue, color, label, displayValue }) => {
            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const percentage = Math.min(value / maxValue, 1);
            const strokeDashoffset = circumference - (percentage * circumference);

            return (
                <div className="relative bg-white p-4 rounded-lg border border-gray-200">
                    <div className="text-center mb-2">
                        <div className="text-xs font-medium text-gray-600">{label}</div>
                    </div>
                    <div className="gauge-chart mx-auto">
                        <svg className="gauge-svg" width="120" height="120">
                            <circle
                                cx="60"
                                cy="60"
                                r={radius}
                                className="gauge-bg"
                            />
                            <circle
                                cx="60"
                                cy="60"
                                r={radius}
                                className="gauge-fill"
                                style={{
                                    stroke: color,
                                    strokeDasharray: circumference,
                                    strokeDashoffset: strokeDashoffset
                                }}
                            />
                        </svg>
                        <div className="gauge-text">
                            <div className="text-lg font-bold" style={{ color }}>
                                {displayValue}
                            </div>
                            <div className="text-xs text-gray-500">{label.split(' ')[0]}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const BudgetAdjustmentCard = ({ client }) => {
            if (client.isHistorical) {
                const hitTarget = client.used <= 105 && client.used >= 95;
                const underBudget = client.used < 95;
                const overBudget = client.used > 105;
                
                return (
                    <div className={`mt-4 p-4 rounded-lg border ${
                        hitTarget ? 'bg-green-50 border-green-200' :
                        underBudget ? 'bg-blue-50 border-blue-200' :
                        'bg-red-50 border-red-200'
                    }`}>
                        <div className="flex items-center justify-between">
                            <div>
                                <div className="font-bold text-sm">
                                    {hitTarget ? '‚úÖ Target Hit' :
                                     underBudget ? 'üìâ Under Budget' :
                                     'üìà Over Budget'}
                                </div>
                                <div className="text-xs opacity-75">
                                    Final spend: ¬£{client.total.toFixed(0)} of ¬£{client.budget} budget
                                    ({client.used.toFixed(1)}%)
                                </div>
                            </div>
                            <div className={`text-lg font-bold ${
                                hitTarget ? 'text-green-600' :
                                underBudget ? 'text-blue-600' :
                                'text-red-600'
                            }`}>
                                {underBudget ? `-¬£${(client.budget - client.total).toFixed(0)}` :
                                 overBudget ? `+¬£${(client.total - client.budget).toFixed(0)}` :
                                 'On Target'}
                            </div>
                        </div>
                    </div>
                );
            }
            
            const calculateTargetDailyBudget = () => {
                if (client.daysLeft <= 0) return { recommended: 0, change: 0, message: "Period ended" };
                
                if (client.total >= client.budget) {
                    return {
                        recommended: 0,
                        change: -client.currentDailyBudget,
                        changePercentage: -100,
                        message: "Already over budget - pause campaigns to avoid further overspend",
                        urgency: "critical"
                    };
                }
                
                const remainingBudget = client.budget - client.total;
                const targetDailySpend = remainingBudget / client.daysLeft;
                const recommendedDailyBudget = Math.max(0, targetDailySpend);
                const currentDailyBudget = client.currentDailyBudget;
                const change = recommendedDailyBudget - currentDailyBudget;
                const changePercentage = currentDailyBudget > 0 ? (change / currentDailyBudget) * 100 : 0;
                
                let message = "";
                let urgency = "normal";
                
                if (Math.abs(changePercentage) < 5) {
                    message = "Current budget is close to optimal";
                    urgency = "good";
                } else if (change > 0) {
                    message = `Increase budget to hit target (${changePercentage.toFixed(0)}% increase needed)`;
                    urgency = "increase";
                } else {
                    message = `Decrease budget to avoid overspend (${Math.abs(changePercentage).toFixed(0)}% decrease needed)`;
                    urgency = "decrease";
                }
                
                return {
                    recommended: recommendedDailyBudget,
                    change: change,
                    changePercentage: changePercentage,
                    message: message,
                    urgency: urgency
                };
            };

            const calculatePlatformRecommendations = () => {
                const adjustment = calculateTargetDailyBudget();
                
                if (adjustment.recommended <= 0) {
                    return {
                        google: 0,
                        facebook: 0,
                        googleChange: -client.googleDailyBudget,
                        facebookChange: -client.facebookDailyBudget
                    };
                }
                
                const totalCurrentBudget = client.googleDailyBudget + client.facebookDailyBudget;
                
                if (totalCurrentBudget <= 0) {
                    return {
                        google: adjustment.recommended / 2,
                        facebook: adjustment.recommended / 2,
                        googleChange: (adjustment.recommended / 2) - client.googleDailyBudget,
                        facebookChange: (adjustment.recommended / 2) - client.facebookDailyBudget
                    };
                }
                
                const googleRatio = client.googleDailyBudget / totalCurrentBudget;
                const facebookRatio = client.facebookDailyBudget / totalCurrentBudget;
                
                const recommendedGoogle = adjustment.recommended * googleRatio;
                const recommendedFacebook = adjustment.recommended * facebookRatio;
                
                return {
                    google: recommendedGoogle,
                    facebook: recommendedFacebook,
                    googleChange: recommendedGoogle - client.googleDailyBudget,
                    facebookChange: recommendedFacebook - client.facebookDailyBudget
                };
            };

            const adjustment = calculateTargetDailyBudget();
            const platformRecs = calculatePlatformRecommendations();

            if (client.status === 'ON TRACK') {
                return (
                    <div className="mt-4 p-4 rounded-lg bg-green-50 border border-green-200">
                        <div className="flex items-center justify-center text-green-800">
                            <span className="text-lg">‚úÖ</span>
                            <div className="ml-2">
                                <div className="font-bold">Budget On Track</div>
                                <div className="text-sm">Current daily budget of ¬£{client.currentDailyBudget.toFixed(0)} is optimal</div>
                            </div>
                        </div>
                    </div>
                );
            }

            const getCardStyle = () => {
                switch (adjustment.urgency) {
                    case 'critical':
                        return 'bg-red-50 border-red-300 text-red-900';
                    case 'increase':
                        return 'bg-blue-50 border-blue-300 text-blue-900';
                    case 'decrease':
                        return 'bg-orange-50 border-orange-300 text-orange-900';
                    default:
                        return 'bg-gray-50 border-gray-300 text-gray-900';
                }
            };

            const getIcon = () => {
                switch (adjustment.urgency) {
                    case 'critical':
                        return 'üö®';
                    case 'increase':
                        return 'üìà';
                    case 'decrease':
                        return 'üìâ';
                    default:
                        return '‚öôÔ∏è';
                }
            };

            return (
                <div className={`mt-4 p-4 rounded-lg border-2 ${getCardStyle()}`}>
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center">
                            <span className="text-xl mr-2">{getIcon()}</span>
                            <div>
                                <div className="font-bold text-sm">Budget Adjustment Needed</div>
                                <div className="text-xs opacity-75">{adjustment.message}</div>
                            </div>
                        </div>
                        {adjustment.urgency === 'critical' && (
                            <div className="text-xs bg-red-200 px-2 py-1 rounded font-bold">
                                URGENT
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <div className="text-xs font-medium opacity-75">TOTAL DAILY BUDGET</div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm">Current:</span>
                                <span className="font-bold">¬£{client.currentDailyBudget.toFixed(0)}/day</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm">Recommended:</span>
                                <span className="font-bold text-lg">¬£{adjustment.recommended.toFixed(0)}/day</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm">Change:</span>
                                <span className={`font-bold ${adjustment.change > 0 ? 'text-blue-700' : 'text-orange-700'}`}>
                                    {adjustment.change > 0 ? '+' : ''}¬£{adjustment.change.toFixed(0)}/day
                                    {Math.abs(adjustment.changePercentage) > 1 && (
                                        <span className="text-xs ml-1">
                                            ({adjustment.changePercentage > 0 ? '+' : ''}{adjustment.changePercentage.toFixed(0)}%)
                                        </span>
                                    )}
                                </span>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <div className="text-xs font-medium opacity-75">PLATFORM BREAKDOWN</div>
                            
                            {(client.googleDailyBudget > 0 || platformRecs.google > 0) && (
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-orange-600">Google:</span>
                                    <div className="text-right">
                                        <div className="font-semibold">¬£{platformRecs.google.toFixed(0)}/day</div>
                                        {Math.abs(platformRecs.googleChange) > 1 && (
                                            <div className={`text-xs ${platformRecs.googleChange > 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                ({platformRecs.googleChange > 0 ? '+' : ''}¬£{platformRecs.googleChange.toFixed(0)})
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {(client.facebookDailyBudget > 0 || platformRecs.facebook > 0) && (
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-purple-600">Meta:</span>
                                    <div className="text-right">
                                        <div className="font-semibold">¬£{platformRecs.facebook.toFixed(0)}/day</div>
                                        {Math.abs(platformRecs.facebookChange) > 1 && (
                                            <div className={`text-xs ${platformRecs.facebookChange > 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                ({platformRecs.facebookChange > 0 ? '+' : ''}¬£{platformRecs.facebookChange.toFixed(0)})
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="mt-3 pt-3 border-t border-current opacity-50">
                        <div className="text-xs">
                            <span className="font-medium">With this change:</span>
                            {" "}Final spend would be approximately ¬£{(client.total + (adjustment.recommended * client.daysLeft)).toFixed(0)}
                            {" "}({((client.total + (adjustment.recommended * client.daysLeft)) / client.budget * 100).toFixed(0)}% of target)
                        </div>
                    </div>
                </div>
            );
        };

        const ClientCard = ({ client }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            
            const getCardStyle = () => {
                if (client.isHistorical) {
                    const hitTarget = client.used <= 105 && client.used >= 95;
                    if (hitTarget) return 'historical-badge hit-target';
                    if (client.used < 95) return 'historical-badge';
                    return 'historical-badge missed-target';
                }
                return 'bg-green-50 border-green-300';
            };
            
            const getKPIData = () => {
                let conversionLabel = 'Conversions';
                let conversionValue = 0;
                let conversionIcon = 'üéØ';
                
                if (client.name.includes('HC-One')) {
                    if (client.name.includes('Nursing')) {
                        conversionLabel = 'Nurse Apps';
                        conversionValue = client.nursingConversions || 0;
                        conversionIcon = 'üë©‚Äç‚öïÔ∏è';
                    } else if (client.name.includes('England/Wales')) {
                        conversionLabel = 'Care Apps';
                        conversionValue = client.careConversions || 0;
                        conversionIcon = 'üè•';
                    }
                } else if (client.name === 'Apollo') {
                    conversionLabel = 'Applications';
                    conversionValue = (client.careConversions || 0) + (client.nursingConversions || 0);
                    conversionIcon = 'üìã';
                } else if (client.name === 'Cygnet Nursing') {
                    conversionLabel = 'Nurse Apps';
                    conversionValue = client.nursingConversions || 0;
                    conversionIcon = 'üë©‚Äç‚öïÔ∏è';
                } else if (client.name === 'Cygnet Care') {
                    conversionLabel = 'Care Apps';
                    conversionValue = client.careConversions || 0;
                    conversionIcon = 'üè•';
                } else {
                    conversionValue = client.conversions || 0;
                }
                
                const cpa = conversionValue > 0 ? (client.total / conversionValue).toFixed(2) : 'N/A';
                const ctr = client.ctr || '0.00';
                
                const prevConversions = client.previousPeriod?.conversions || 
                                      client.previousPeriod?.nursingConversions || 
                                      client.previousPeriod?.careConversions || 0;
                const prevCPA = client.previousPeriod?.cpa || null;
                const prevCTR = client.previousPeriod?.ctr || null;
                
                const conversionTrend = prevConversions > 0 ? 
                    ((conversionValue - prevConversions) / prevConversions * 100) : null;
                
                const cpaTrend = prevCPA && cpa !== 'N/A' ? 
                    ((parseFloat(cpa) - prevCPA) / prevCPA * 100) : null;
                
                const ctrTrend = prevCTR ? 
                    ((parseFloat(ctr) - prevCTR) / prevCTR * 100) : null;
                
                const prevConversionDisplay = prevConversions > 0 ? prevConversions.toString() : null;
                const prevCPADisplay = prevCPA ? `¬£${prevCPA.toFixed(2)}` : null;
                const prevCTRDisplay = prevCTR ? `${prevCTR.toFixed(2)}%` : null;
                
                const getConversionPerformance = () => {
                    if (conversionValue === 0) return 'poor';
                    if (conversionValue > 50) return 'excellent';
                    if (conversionValue > 30) return 'good';
                    if (conversionValue > 15) return 'average';
                    return 'poor';
                };
                
                const getCPAPerformance = () => {
                    if (cpa === 'N/A') return 'poor';
                    const cpaValue = parseFloat(cpa);
                    if (cpaValue < 30) return 'excellent';
                    if (cpaValue < 50) return 'good';
                    if (cpaValue < 75) return 'average';
                    return 'poor';
                };
                
                const getCTRPerformance = () => {
                    const ctrValue = parseFloat(ctr);
                    if (ctrValue > 3) return 'excellent';
                    if (ctrValue > 2) return 'good';
                    if (ctrValue > 1) return 'average';
                    return 'poor';
                };
                
                return {
                    conversions: {
                        label: conversionLabel,
                        value: conversionValue,
                        unit: '',
                        trend: client.isHistorical ? null : conversionTrend,
                        previousValue: client.isHistorical ? null : prevConversionDisplay,
                        performance: getConversionPerformance(),
                        icon: conversionIcon
                    },
                    cpa: {
                        label: 'Cost Per ' + (conversionLabel.includes('App') ? 'App' : 'Conversion'),
                        value: cpa !== 'N/A' ? `¬£${cpa}` : 'N/A',
                        unit: '',
                        trend: client.isHistorical ? null : cpaTrend,
                        previousValue: client.isHistorical ? null : prevCPADisplay,
                        performance: getCPAPerformance(),
                        icon: 'üí∞',
                        invertTrend: true
                    },
                    ctr: {
                        label: 'Click-Through Rate',
                        value: ctr,
                        unit: '%',
                        trend: client.isHistorical ? null : ctrTrend,
                        previousValue: client.isHistorical ? null : prevCTRDisplay,
                        performance: getCTRPerformance(),
                        icon: 'üëÜ'
                    }
                };
            };
            
            const kpiData = useMemo(() => getKPIData(), [client]);
            
            return (
                <div className={`border-2 rounded-xl p-6 transition-all hover:shadow-lg ${getCardStyle()}`}>
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <h3 className="font-bold text-lg text-gray-900">{client.name}</h3>
                            <div className="text-sm text-gray-600 mt-1">{client.period}</div>
                            {client.isHistorical && (
                                <div className="text-xs text-gray-500 italic mt-1">Historical Period</div>
                            )}
                        </div>
                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                            client.status === 'HOT' || client.status === 'OVER BUDGET' ? 'bg-red-100 text-red-800 border-red-200' :
                            client.status === 'COLD' ? 'bg-blue-100 text-blue-800 border-blue-200' :
                            client.status === 'COMPLETE' ? 'bg-gray-100 text-gray-800 border-gray-200' :
                            'bg-green-100 text-green-800 border-green-200'
                        }`}>
                            {client.status === 'ON TRACK' ? '‚úÖ ON TRACK' : 
                             client.status === 'HOT' ? 'üî• HOT' : 
                             client.status === 'OVER BUDGET' ? 'üö® OVER BUDGET' : 
                             client.status === 'COMPLETE' ? 'üìä COMPLETE' : 'üßä COLD'}
                        </span>
                    </div>
                    
                    <div className={`grid grid-cols-1 ${client.isHistorical ? '' : 'md:grid-cols-3'} gap-4 mb-4`}>
                        <GaugeChart
                            value={client.used}
                            maxValue={100}
                            color={client.used < 60 ? '#10B981' : client.used < 85 ? '#F59E0B' : '#EF4444'}
                            label="Budget Usage"
                            displayValue={`${client.used.toFixed(0)}%`}
                        />
                        
                        {!client.isHistorical && (
                            <>
                                <div className="relative bg-white p-4 rounded-lg border border-gray-200">
                                    <div className="text-center mb-2">
                                        <div className="text-xs font-medium text-gray-600">Spending Pace</div>
                                    </div>
                                    <div className="gauge-chart mx-auto">
                                        <svg className="gauge-svg" width="120" height="120">
                                            <circle cx="60" cy="60" r={45} className="gauge-bg"/>
                                            <circle
                                                cx="60" cy="60" r={45} className="gauge-fill"
                                                style={{
                                                    stroke: client.status === 'COLD' ? '#3B82F6' : client.status === 'HOT' ? '#EF4444' : '#10B981',
                                                    strokeDasharray: 2 * Math.PI * 45,
                                                    strokeDashoffset: (2 * Math.PI * 45) - (100 / 150 * (2 * Math.PI * 45))
                                                }}
                                            />
                                        </svg>
                                        <div className="gauge-text">
                                            <div className={`text-lg font-bold ${
                                                client.status === 'COLD' ? 'text-blue-600' :
                                                client.status === 'HOT' ? 'text-red-600' : 'text-green-600'
                                            }`}>
                                                {client.status === 'ON TRACK' ? '‚úì' : 
                                                 client.status === 'HOT' ? 'üî•' : 'üßä'}
                                            </div>
                                            <div className="text-xs text-gray-500">{client.status}</div>
                                        </div>
                                    </div>
                                </div>

                                <GaugeChart
                                    value={Math.min((client.projectedSpend / client.budget) * 100, 130)}
                                    maxValue={130}
                                    color={client.projectedOverBudget > 10 ? '#EF4444' : 
                                          client.projectedOverBudget > 0 ? '#F59E0B' : 
                                          client.projectedOverBudget > -20 ? '#10B981' : '#3B82F6'}
                                    label="Projected vs Budget"
                                    displayValue={`¬£${client.projectedSpend.toFixed(0)}`}
                                />
                            </>
                        )}
                    </div>

                    <div className="grid grid-cols-3 gap-3 mb-4">
                        <KPIScorecard
                            label={kpiData.conversions.label}
                            value={kpiData.conversions.value}
                            unit={kpiData.conversions.unit}
                            trend={kpiData.conversions.trend}
                            previousValue={kpiData.conversions.previousValue}
                            performance={kpiData.conversions.performance}
                            icon={kpiData.conversions.icon}
                        />
                        <KPIScorecard
                            label={kpiData.cpa.label}
                            value={kpiData.cpa.value}
                            unit={kpiData.cpa.unit}
                            trend={kpiData.cpa.trend}
                            previousValue={kpiData.cpa.previousValue}
                            performance={kpiData.cpa.performance}
                            icon={kpiData.cpa.icon}
                            invertTrend={kpiData.cpa.invertTrend}
                        />
                        <KPIScorecard
                            label={kpiData.ctr.label}
                            value={kpiData.ctr.value}
                            unit={kpiData.ctr.unit}
                            trend={kpiData.ctr.trend}
                            previousValue={kpiData.ctr.previousValue}
                            performance={kpiData.ctr.performance}
                            icon={kpiData.ctr.icon}
                        />
                    </div>

                    <BudgetAdjustmentCard client={client} />

                    <div className="mt-4 border-t pt-4">
                        <button
                            onClick={() => setIsExpanded(!isExpanded)}
                            className="w-full flex items-center justify-between text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors"
                        >
                            <span>Budget Details</span>
                            <svg 
                                className={`w-5 h-5 chevron ${isExpanded ? 'rotated' : ''}`}
                                fill="none" 
                                stroke="currentColor" 
                                viewBox="0 0 24 24"
                            >
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        
                        <div className={`collapsible-content ${isExpanded ? 'expanded' : 'collapsed'}`}>
                            <div className="space-y-3 mt-4">
                                <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">Total Spend</span>
                                    <span className="font-bold text-lg">¬£{client.total.toFixed(0)}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">Monthly Budget</span>
                                    <span className="font-semibold">
                                        ¬£{client.budget} (¬£{(client.budget / client.totalDays).toFixed(0)}/day)
                                    </span>
                                </div>
                                {!client.isHistorical && (
                                    <>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Projected Spend</span>
                                            <span className={`font-semibold ${
                                                client.projectedOverBudget > 5 ? 'text-red-600' :
                                                client.projectedOverBudget > -5 ? 'text-orange-600' : 'text-green-600'
                                            }`}>
                                                ¬£{client.projectedSpend.toFixed(0)}
                                                {client.projectedOverBudget > 0 && (
                                                    <span className="text-xs ml-1">
                                                        (+{client.projectedOverBudget.toFixed(0)}%)
                                                    </span>
                                                )}
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Platform Daily Budget</span>
                                            <span className="font-semibold text-cyan-600">¬£{client.currentDailyBudget.toFixed(0)}/day</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-gray-600">Days Left</span>
                                            <span className="font-semibold">{client.daysLeft} days</span>
                                        </div>
                                    </>
                                )}
                                
                                {(client.google > 0 || client.facebook > 0) && (
                                    <div className="border-t pt-3 mt-3">
                                        <div className="text-sm font-medium text-gray-700 mb-2">Platform Split</div>
                                        <div className="grid grid-cols-2 gap-4 text-xs">
                                            <div>
                                                <div className="flex justify-between mb-1">
                                                    <span className="text-gray-600">Google Spend</span>
                                                    <span className="font-semibold text-orange-600">¬£{client.google.toFixed(0)}</span>
                                                </div>
                                                {!client.isHistorical && client.googleDailyBudget > 0 && (
                                                    <div className="flex justify-between">
                                                        <span className="text-gray-600">Google Budget</span>
                                                        <span className="font-semibold text-orange-600">¬£{client.googleDailyBudget.toFixed(0)}/day</span>
                                                    </div>
                                                )}
                                            </div>
                                            <div>
                                                <div className="flex justify-between mb-1">
                                                    <span className="text-gray-600">Meta Spend</span>
                                                    <span className="font-semibold text-purple-600">¬£{client.facebook.toFixed(0)}</span>
                                                </div>
                                                {!client.isHistorical && client.facebookDailyBudget > 0 && (
                                                    <div className="flex justify-between">
                                                        <span className="text-gray-600">Meta Budget</span>
                                                        <span className="font-semibold text-purple-600">¬£{client.facebookDailyBudget.toFixed(0)}/day</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ClientBudgetTable = () => {
            const [rawData, setRawData] = useState({});
            const [conversionData, setConversionData] = useState({});
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [logs, setLogs] = useState([]);
            const [showLogs, setShowLogs] = useState(false);
            const [selectedMonth, setSelectedMonth] = useState('current');

            const PROXY_URL = 'https://sheets-proxy-ria9.vercel.app/api/sheets-proxy';
            const SPREADSHEET_ID = '1nbVrRxhIh2RLa5qtOsaM1N_UmqljztVwxPbQRCnkBcs';
            const API_KEY = 'AIzaSyDffl5VtZDXxAMJ-Cnbay7CbO-PPfF42fI';
            const VERSION = 'v2.24.0'; // HC-One Scotland removed

            const getAvailableMonths = useCallback(() => {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth();
                
                const months = [
                    { value: 'current', label: 'Current Period', isCurrent: true }
                ];
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                 'July', 'August', 'September', 'October', 'November', 'December'];
                
                for (let i = 0; i <= currentMonth; i++) {
                    months.push({
                        value: `${currentYear}-${String(i + 1).padStart(2, '0')}`,
                        label: `${monthNames[i]} ${currentYear}`,
                        isCurrent: false
                    });
                }
                
                return months;
            }, []);

            const availableMonths = useMemo(() => getAvailableMonths(), [getAvailableMonths]);

            const getHistoricalPeriod = useCallback((year, month, clientType) => {
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                if (clientType === 'apollo') {
                    const startMonth = month - 1 < 0 ? 11 : month - 1;
                    const endMonth = month;
                    return `${monthNames[startMonth]} 26 - ${monthNames[endMonth]} 25`;
                } else if (clientType === 'hc1') {
                    const startMonth = month - 1 < 0 ? 11 : month - 1;
                    const endMonth = month;
                    return `${monthNames[startMonth]} 11 - ${monthNames[endMonth]} 10`;
                } else {
                    const lastDay = new Date(year, month + 1, 0).getDate();
                    return `${monthNames[month]} 1 - ${monthNames[month]} ${lastDay}`;
                }
            }, []);

            const getCurrentPeriod = useCallback((clientType) => {
                const today = new Date();
                
                if (clientType === 'apollo') {
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    const day = today.getDate();
                    
                    let startMonth, endMonth;
                    let startYear = currentYear;
                    let endYear = currentYear;
                    
                    if (day >= 26) {
                        startMonth = currentMonth;
                        endMonth = currentMonth + 1;
                        if (endMonth > 11) {
                            endMonth = 0;
                            endYear = currentYear + 1;
                        }
                    } else {
                        startMonth = currentMonth - 1;
                        endMonth = currentMonth;
                        if (startMonth < 0) {
                            startMonth = 11;
                            startYear = currentYear - 1;
                        }
                    }
                    
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const periodString = `${monthNames[startMonth]} 26 - ${monthNames[endMonth]} 25`;
                    return periodString;
                } else if (clientType === 'hc1') {
                    const currentMonth = today.getMonth();
                    const day = today.getDate();
                    
                    let startMonth, endMonth;
                    
                    if (day >= 11) {
                        startMonth = currentMonth;
                        endMonth = currentMonth + 1;
                    } else {
                        startMonth = currentMonth - 1;
                        endMonth = currentMonth;
                    }
                    
                    if (startMonth < 0) startMonth = 11;
                    if (endMonth > 11) endMonth = 0;
                    
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${monthNames[startMonth]} 11 - ${monthNames[endMonth]} 10`;
                } else {
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const currentMonthName = monthNames[currentMonth];
                    const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
                    
                    return `${currentMonthName} 1 - ${currentMonthName} ${lastDay}`;
                }
            }, []);

            const getPreviousPeriodDates = useCallback((clientType, currentPeriodStart, currentPeriodEnd, daysElapsed) => {
                const prevPeriodEnd = new Date(currentPeriodStart);
                prevPeriodEnd.setDate(prevPeriodEnd.getDate() - 1);
                
                const prevPeriodStart = new Date(prevPeriodEnd);
                
                if (clientType === 'apollo') {
                    prevPeriodStart.setMonth(prevPeriodStart.getMonth() - 1);
                    prevPeriodStart.setDate(26);
                } else if (clientType === 'hc1') {
                    prevPeriodStart.setMonth(prevPeriodStart.getMonth() - 1);
                    prevPeriodStart.setDate(11);
                } else {
                    prevPeriodStart.setMonth(prevPeriodStart.getMonth() - 1);
                    prevPeriodStart.setDate(1);
                }
                
                const adjustedPrevEnd = new Date(prevPeriodStart);
                adjustedPrevEnd.setDate(adjustedPrevEnd.getDate() + daysElapsed - 1);
                
                return { start: prevPeriodStart, end: adjustedPrevEnd };
            }, []);

            const getTotalDays = useCallback((clientType, selectedMonth = null) => {
                if (clientType === 'apollo' || clientType === 'hc1') {
                    return 30;
                } else {
                    if (selectedMonth && selectedMonth !== 'current') {
                        const [year, month] = selectedMonth.split('-').map(Number);
                        return new Date(year, month, 0).getDate();
                    }
                    const today = new Date();
                    return new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                }
            }, []);

            const clientConfig = useMemo(() => {
                const isHistorical = selectedMonth !== 'current';
                let period, year, month;
                
                if (isHistorical) {
                    [year, month] = selectedMonth.split('-').map(Number);
                    month = month - 1;
                }
                
                return {
                    'Apollo': {
                        campaigns: [
                            'Always on HCA & Support Works National Search',
                            'North West Conversions Campaign April 30th'
                        ],
                        budget: 1221,
                        period: isHistorical ? getHistoricalPeriod(year, month, 'apollo') : getCurrentPeriod('apollo'),
                        totalDays: getTotalDays('apollo', selectedMonth),
                        clientType: 'apollo',
                        note: 'Budget increased to ¬£60/day each platform'
                    },
                    'Cygnet Care': {
                        campaigns: ['Care and Support Always On Performance Max', 'Care and Support Always On - Conversions 2025', 'Care and Support Always On - Traffic - 2024'],
                        budget: 800,
                        period: isHistorical ? getHistoricalPeriod(year, month, 'standard') : getCurrentPeriod('standard'),
                        totalDays: getTotalDays('standard', selectedMonth),
                        clientType: 'standard',
                        tabPrefix: 'Cygnet'
                    },
                    'Cygnet Nursing': {
                        campaigns: ['Nursing always on Performance Max', 'Always On Nursing Search', 'Nursing Always on April 2024'],
                        budget: 800,
                        period: isHistorical ? getHistoricalPeriod(year, month, 'standard') : getCurrentPeriod('standard'),
                        totalDays: getTotalDays('standard', selectedMonth),
                        clientType: 'standard',
                        tabPrefix: 'Cygnet',
                        skipTabs: true
                    },
                    'HC-One - England/Wales': {
                        campaigns: [
                            'AL -  Always on Care Search Campaign',
                            'Always on Care',
                            'HC-One Always On Campaign'
                        ],
                        budget: 1800,
                        period: isHistorical ? getHistoricalPeriod(year, month, 'hc1') : getCurrentPeriod('hc1'),
                        totalDays: getTotalDays('hc1', selectedMonth),
                        clientType: 'hc1',
                        tabPrefix: 'HC1'
                    },
                    'HC-One - Nursing': {
                        campaigns: [
                            'AL - Always On Nursing Search',
                            'HC-One Always On Nursing ‚Äì Conversion'
                        ],
                        budget: 1000,
                        period: isHistorical ? getHistoricalPeriod(year, month, 'hc1') : getCurrentPeriod('hc1'),
                        totalDays: getTotalDays('hc1', selectedMonth),
                        clientType: 'hc1',
                        tabPrefix: 'HC1',
                        skipTabs: true
                    }
                };
            }, [getCurrentPeriod, getTotalDays, getHistoricalPeriod, selectedMonth]);

            const addLog = useCallback((message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [...prev, { message, type, timestamp }]);
                console.log(`[${timestamp}] ${message}`);
            }, []);

            const clearLogs = useCallback(() => {
                setLogs([]);
            }, []);

            const parseDateRange = (dateRange, isHistorical = false, year = null, month = null) => {
                const parts = dateRange.split(' - ');
                if (parts.length !== 2) return { start: null, end: null };
                
                const today = new Date();
                const currentYear = isHistorical && year ? year : today.getFullYear();
                const currentMonth = today.getMonth();
                const currentDay = today.getDate();
                
                const monthMap = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                };
                
                const [startMonthName, startDayStr] = parts[0].trim().split(' ');
                const [endMonthName, endDayStr] = parts[1].trim().split(' ');
                
                const startMonthIndex = monthMap[startMonthName];
                const endMonthIndex = monthMap[endMonthName];
                const startDay = parseInt(startDayStr);
                const endDay = parseInt(endDayStr);
                
                let startYear = currentYear;
                let endYear = currentYear;
                
                if (isHistorical) {
                    if (startDay === 26 && endDay === 25) {
                        if (endMonthIndex === month) {
                            endYear = year;
                            startYear = startMonthIndex > endMonthIndex ? year - 1 : year;
                        }
                    } else if (startDay === 11 && endDay === 10) {
                        if (endMonthIndex === month) {
                            endYear = year;
                            startYear = startMonthIndex > endMonthIndex ? year - 1 : year;
                        }
                    } else if (startMonthIndex === endMonthIndex) {
                        startYear = year;
                        endYear = year;
                    }
                } else {
                    if (startDay === 26 && endDay === 25) {
                        if (currentDay >= 26) {
                            if (startMonthIndex === currentMonth) {
                                startYear = currentYear;
                                if (endMonthIndex < startMonthIndex) {
                                    endYear = currentYear + 1;
                                } else {
                                    endYear = currentYear;
                                }
                            }
                        } else {
                            if (endMonthIndex === currentMonth) {
                                endYear = currentYear;
                                if (startMonthIndex > endMonthIndex) {
                                    startYear = currentYear - 1;
                                } else {
                                    startYear = currentYear;
                                }
                            }
                        }
                    } else if (startDay === 11 && endDay === 10) {
                        if (currentDay >= 11) {
                            if (startMonthIndex === currentMonth) {
                                startYear = currentYear;
                                endYear = currentMonth === 11 ? currentYear + 1 : currentYear;
                            }
                        } else {
                            if (endMonthIndex === currentMonth) {
                                endYear = currentYear;
                                startYear = startMonthIndex === 11 && currentMonth === 0 ? currentYear - 1 : currentYear;
                            }
                        }
                    }
                }
                
                const startDate = new Date(startYear, startMonthIndex, startDay);
                const endDate = new Date(endYear, endMonthIndex, endDay);
                
                return { start: startDate, end: endDate };
            };

            const isDateInRange = (date, startDate, endDate) => {
                const checkDate = new Date(date);
                const normalizedCheck = new Date(checkDate.getFullYear(), checkDate.getMonth(), checkDate.getDate());
                const normalizedStart = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                const normalizedEnd = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
                
                return normalizedCheck >= normalizedStart && normalizedCheck <= normalizedEnd;
            };

            const loadData = async () => {
                clearLogs();
                addLog('Starting data load process...', 'info');
                setLoading(true);
                setError(null);

                try {
                    const allData = {};
                    const conversions = {};
                    
                    const expectedTabs = ['Apollo Google', 'Apollo FB', 'Cygnet Google', 'Cygnet FB', 'HC1 Google', 'HC1 FB'];

                    for (const tabName of expectedTabs) {
                        try {
                            addLog(`Fetching data from tab: ${tabName}`, 'info');
                            
                            const range = tabName.includes('FB') ? `${tabName}!A:H` : `${tabName}!A:F`;
                            const url = `${PROXY_URL}?spreadsheetId=${SPREADSHEET_ID}&range=${encodeURIComponent(range)}&apiKey=${API_KEY}`;
                            
                            const response = await fetch(url);
                            
                            if (response.ok) {
                                const data = await response.json();
                                
                                if (data.values && data.values.length > 1) {
                                    const headers = data.values[0];
                                    const rows = data.values.slice(1);
                                    
                                    const tabData = rows.map(row => {
                                        const rowData = {};
                                        headers.forEach((header, index) => {
                                            const headerLower = header.toLowerCase();
                                            
                                            if (tabName.includes('FB')) {
                                                if (header === 'Campaign name') {
                                                    rowData['Campaign'] = row[index] || '';
                                                } else if (header === 'Amount spent' || header === 'Amount spent (GBP)') {
                                                    rowData['Cost'] = row[index] || '';
                                                } else if (header === 'Adset name') {
                                                    rowData['AdsetName'] = row[index] || '';
                                                } else if (header === 'Adset daily budget') {
                                                    rowData['DailyBudget'] = row[index] || '';
                                                } else if (header === 'CTR (Link click-through rate)' || header === 'Unique inline link click CTR' || headerLower.includes('ctr')) {
                                                    rowData['CTR'] = row[index] || '';
                                                } else if (header === 'Event conversion Care Custom Conversion' || header === 'Event conversion Care Application' || (headerLower.includes('care') && (headerLower.includes('conv') || headerLower.includes('app')))) {
                                                    rowData['CareApplications'] = row[index] || '';
                                                } else if (header === 'Event conversion Nurse Custom Conversion' || header === 'Event conversion Nurse Application' || (headerLower.includes('nurs') && (headerLower.includes('conv') || headerLower.includes('app')))) {
                                                    rowData['NursingApplications'] = row[index] || '';
                                                } else {
                                                    rowData[header] = row[index] || '';
                                                }
                                            } else {
                                                if (header === 'Budget Amount') {
                                                    rowData['DailyBudget'] = row[index] || '';
                                                } else if (headerLower.includes('ctr')) {
                                                    rowData['CTR'] = row[index] || '';
                                                } else {
                                                    rowData[header] = row[index] || '';
                                                }
                                            }
                                        });
                                        return rowData;
                                    });
                                    
                                    allData[tabName] = tabData;
                                    addLog(`‚úÖ Loaded ${tabData.length} rows from ${tabName}`, 'success');
                                }
                            }
                        } catch (tabError) {
                            addLog(`‚ùå Error fetching tab ${tabName}: ${tabError.message}`, 'error');
                        }
                    }

                    try {
                        addLog('Fetching HC1 Google Conversions data...', 'info');
                        const conversionRange = 'HC1 Google Conversions!A:D';
                        const url = `${PROXY_URL}?spreadsheetId=${SPREADSHEET_ID}&range=${encodeURIComponent(conversionRange)}&apiKey=${API_KEY}`;
                        
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.values && data.values.length > 1) {
                                const headers = data.values[0];
                                const rows = data.values.slice(1);
                                
                                const conversionData = rows.map(row => {
                                    const rowData = {};
                                    headers.forEach((header, index) => {
                                        rowData[header] = row[index] || '';
                                    });
                                    return rowData;
                                });
                                
                                conversions['HC1 Google Conversions'] = conversionData;
                                addLog(`‚úÖ Loaded ${conversionData.length} rows from HC1 Google Conversions`, 'success');
                            }
                        }
                    } catch (convError) {
                        addLog(`‚ö†Ô∏è Could not load HC1 Google Conversions: ${convError.message}`, 'warning');
                    }

                    try {
                        addLog('Fetching Apollo Google Conversions data...', 'info');
                        const apolloConversionRange = 'Apollo Google Conversions!A:D';
                        const url = `${PROXY_URL}?spreadsheetId=${SPREADSHEET_ID}&range=${encodeURIComponent(apolloConversionRange)}&apiKey=${API_KEY}`;
                        
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.values && data.values.length > 1) {
                                const headers = data.values[0];
                                const rows = data.values.slice(1);
                                
                                const conversionData = rows.map(row => {
                                    const rowData = {};
                                    headers.forEach((header, index) => {
                                        rowData[header] = row[index] || '';
                                    });
                                    return rowData;
                                });
                                
                                conversions['Apollo Google Conversions'] = conversionData;
                                addLog(`‚úÖ Loaded ${conversionData.length} rows from Apollo Google Conversions`, 'success');
                            }
                        }
                    } catch (convError) {
                        addLog(`‚ö†Ô∏è Could not load Apollo Google Conversions: ${convError.message}`, 'warning');
                    }

                    try {
                        addLog('Fetching Cygnet Google Conversions data...', 'info');
                        const cygnetConversionRange = 'Cygnet Google Conversions!A:D';
                        const url = `${PROXY_URL}?spreadsheetId=${SPREADSHEET_ID}&range=${encodeURIComponent(cygnetConversionRange)}&apiKey=${API_KEY}`;
                        
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.values && data.values.length > 1) {
                                const headers = data.values[0];
                                const rows = data.values.slice(1);
                                
                                const conversionData = rows.map(row => {
                                    const rowData = {};
                                    headers.forEach((header, index) => {
                                        rowData[header] = row[index] || '';
                                    });
                                    return rowData;
                                });
                                
                                conversions['Cygnet Google Conversions'] = conversionData;
                                addLog(`‚úÖ Loaded ${conversionData.length} rows from Cygnet Google Conversions`, 'success');
                            }
                        }
                    } catch (convError) {
                        addLog(`‚ö†Ô∏è Could not load Cygnet Google Conversions: ${convError.message}`, 'warning');
                    }

                    setRawData(allData);
                    setConversionData(conversions);
                    addLog(`üéâ Data loading complete! Loaded ${Object.keys(allData).length} tabs`, 'success');

                } catch (err) {
                    setError(err.message);
                    addLog(`üí• Fatal error: ${err.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const processMetricsForPeriod = (data, conversions, config, periodStart, periodEnd, tabPrefix, clientName) => {
                let googleSpend = 0;
                let facebookSpend = 0;
                let totalCTR = 0;
                let ctrCount = 0;
                let careConversions = 0;
                let nursingConversions = 0;

                const googleTabName = `${tabPrefix} Google`;
                if (data[googleTabName]) {
                    data[googleTabName].forEach(row => {
                        const campaign = row.Campaign || '';
                        const cost = parseFloat(row.Cost) || 0;
                        const ctr = row.CTR ? parseFloat(row.CTR.replace('%', '')) : 0;

                        const matchesCampaign = config.campaigns.includes('*') || 
                                             config.campaigns.some(c => campaign === c);

                        if (matchesCampaign && isDateInRange(row.Date, periodStart, periodEnd)) {
                            googleSpend += cost;
                            
                            if (ctr > 0) {
                                totalCTR += ctr;
                                ctrCount++;
                            }
                        }
                    });
                }

                if (clientName.includes('HC-One') && conversions['HC1 Google Conversions']) {
                    conversions['HC1 Google Conversions'].forEach(row => {
                        const campaign = row.Campaign || '';
                        const matchesCampaign = config.campaigns.some(c => campaign === c);
                        
                        if (matchesCampaign && isDateInRange(row.Date, periodStart, periodEnd)) {
                            const nursingValue = parseFloat(row['HC1 Jobs (web) completed_application_Nursing']) || 0;
                            const careValue = parseFloat(row['HC1 Jobs (web) completed_application_Care']) || 0;
                            
                            nursingConversions += nursingValue;
                            careConversions += careValue;
                        }
                    });
                }

                if (clientName === 'Apollo' && conversions['Apollo Google Conversions']) {
                    conversions['Apollo Google Conversions'].forEach(row => {
                        const campaign = row.Campaign || '';
                        const matchesCampaign = config.campaigns.some(c => campaign === c);
                        
                        if (matchesCampaign && isDateInRange(row.Date, periodStart, periodEnd)) {
                            const careValue = parseFloat(row['Apollo Home Healthcare - GA4 (web) care_application']) || 0;
                            const nursingValue = parseFloat(row['Apollo Home Healthcare - GA4 (web) nurse_application']) || 0;
                            
                            careConversions += careValue;
                            nursingConversions += nursingValue;
                        }
                    });
                }

                if (clientName.includes('Cygnet') && conversions['Cygnet Google Conversions']) {
                    conversions['Cygnet Google Conversions'].forEach(row => {
                        const campaign = row.Campaign || '';
                        const matchesCampaign = config.campaigns.some(c => campaign === c);
                        
                        if (matchesCampaign && isDateInRange(row.Date, periodStart, periodEnd)) {
                            if (clientName === 'Cygnet Nursing') {
                                const nursingValue = parseFloat(row['Submit Nurse Application']) || 0;
                                nursingConversions += nursingValue;
                            } else if (clientName === 'Cygnet Care') {
                                const careValue = parseFloat(row['Submit Care & Support Application']) || 0;
                                careConversions += careValue;
                            }
                        }
                    });
                }

                const facebookTabName = `${tabPrefix} FB`;
                if (data[facebookTabName]) {
                    data[facebookTabName].forEach(row => {
                        const campaign = row.Campaign || '';
                        const cost = parseFloat(row.Cost) || 0;
                        const ctr = row.CTR ? parseFloat(row.CTR.replace('%', '')) : 0;
                        const fbCareApps = parseFloat(row.CareApplications) || 0;
                        const fbNursingApps = parseFloat(row.NursingApplications) || 0;

                        const matchesCampaign = config.campaigns.includes('*') || 
                                             config.campaigns.some(c => campaign === c);

                        if (matchesCampaign && isDateInRange(row.Date, periodStart, periodEnd)) {
                            facebookSpend += cost;
                            
                            if (ctr > 0) {
                                totalCTR += ctr;
                                ctrCount++;
                            }
                            
                            if (clientName === 'Cygnet Nursing') {
                                nursingConversions += fbNursingApps;
                            } else if (clientName === 'Cygnet Care') {
                                careConversions += fbCareApps;
                            } else {
                                careConversions += fbCareApps;
                                nursingConversions += fbNursingApps;
                            }
                        }
                    });
                }

                const total = googleSpend + facebookSpend;
                const avgCTR = ctrCount > 0 ? totalCTR / ctrCount : 0;
                const totalConversions = careConversions + nursingConversions;
                const cpa = totalConversions > 0 ? total / totalConversions : null;

                return {
                    total,
                    googleSpend,
                    facebookSpend,
                    ctr: avgCTR,
                    careConversions,
                    nursingConversions,
                    conversions: totalConversions,
                    cpa
                };
            };

            const processRawData = useCallback((data, conversions) => {
                const today = new Date();
                const processedClients = [];
                const isHistorical = selectedMonth !== 'current';
                let historicalYear, historicalMonth;
                
                if (isHistorical) {
                    [historicalYear, historicalMonth] = selectedMonth.split('-').map(Number);
                    historicalMonth = historicalMonth - 1;
                }

                Object.keys(clientConfig).forEach(clientName => {
                    const config = clientConfig[clientName];
                    const tabPrefix = config.tabPrefix || clientName;
                    const { start: periodStart, end: periodEnd } = parseDateRange(
                        config.period, 
                        isHistorical, 
                        historicalYear, 
                        historicalMonth
                    );
                    
                    if (!periodStart || !periodEnd) return;

                    const daysElapsed = isHistorical ? 
                        config.totalDays : 
                        Math.ceil((today - periodStart) / (1000 * 60 * 60 * 24)) + 1;
                    const daysLeft = isHistorical ? 
                        0 : 
                        Math.max(0, Math.ceil((periodEnd - today) / (1000 * 60 * 60 * 24)) + 1);

                    const currentMetrics = processMetricsForPeriod(
                        data, conversions, config, periodStart, periodEnd, tabPrefix, clientName
                    );

                    let previousPeriodData = null;
                    
                    if (!isHistorical) {
                        const prevPeriodDates = getPreviousPeriodDates(config.clientType, periodStart, periodEnd, daysElapsed);
                        
                        if (prevPeriodDates.start && prevPeriodDates.end) {
                            const prevMetrics = processMetricsForPeriod(
                                data, conversions, config, prevPeriodDates.start, prevPeriodDates.end, tabPrefix, clientName
                            );
                            
                            previousPeriodData = {
                                conversions: prevMetrics.conversions,
                                careConversions: prevMetrics.careConversions,
                                nursingConversions: prevMetrics.nursingConversions,
                                cpa: prevMetrics.cpa,
                                ctr: prevMetrics.ctr
                            };
                        }
                    }

                    let googleDailyBudget = 0;
                    let facebookDailyBudget = 0;

                    if (!isHistorical) {
                        const googleTabName = `${tabPrefix} Google`;
                        if (data[googleTabName]) {
                            let latestDate = null;
                            let latestDateBudget = 0;
                            
                            data[googleTabName].forEach(row => {
                                const campaign = row.Campaign || '';
                                const dailyBudget = parseFloat(row.DailyBudget) || 0;

                                const matchesCampaign = config.campaigns.includes('*') || 
                                                     config.campaigns.some(c => campaign === c);

                                if (matchesCampaign && isDateInRange(row.Date, periodStart, periodEnd)) {
                                    const rowDate = new Date(row.Date);
                                    if (!latestDate || rowDate > latestDate) {
                                        latestDate = rowDate;
                                        latestDateBudget = 0;
                                    }
                                    
                                    if (rowDate.getTime() === latestDate.getTime() && dailyBudget > 0) {
                                        if (clientName === 'Apollo') {
                                            latestDateBudget = dailyBudget;
                                        } else {
                                            latestDateBudget = Math.max(latestDateBudget, dailyBudget);
                                        }
                                    }
                                }
                            });

                            googleDailyBudget = latestDateBudget;
                        }

                        const facebookTabName = `${tabPrefix} FB`;
                        if (data[facebookTabName]) {
                            let latestDate = null;
                            let latestDateBudgets = new Map();
                            
                            data[facebookTabName].forEach(row => {
                                const campaign = row.Campaign || '';
                                const rawBudget = row.DailyBudget || 0;
                                
                                let dailyBudget = 0;
                                if (rawBudget) {
                                    const cleanBudget = String(rawBudget).replace(/,/g, '');
                                    const numericBudget = parseFloat(cleanBudget);
                                    if (!isNaN(numericBudget)) {
                                        dailyBudget = numericBudget / 100;
                                    }
                                }

                                const matchesCampaign = config.campaigns.includes('*') || 
                                                     config.campaigns.some(c => campaign === c);

                                if (matchesCampaign && isDateInRange(row.Date, periodStart, periodEnd)) {
                                    const rowDate = new Date(row.Date);
                                    if (!latestDate || rowDate > latestDate) {
                                        latestDate = rowDate;
                                        latestDateBudgets.clear();
                                    }
                                    
                                    if (rowDate.getTime() === latestDate.getTime() && dailyBudget > 0) {
                                        const adsetKey = `${row.AdsetName || 'unknown'}`;
                                        latestDateBudgets.set(adsetKey, dailyBudget);
                                    }
                                }
                            });

                            facebookDailyBudget = Array.from(latestDateBudgets.values()).reduce((sum, budget) => sum + budget, 0);
                        }
                    }

                    const total = currentMetrics.total;
                    const used = (total / config.budget) * 100;
                    const remaining = config.budget - total;
                    const currentDailyBudget = googleDailyBudget + facebookDailyBudget;
                    const projectedSpend = isHistorical ? total : total + (currentDailyBudget * daysLeft);
                    const projectedOverBudget = ((projectedSpend / config.budget) - 1) * 100;

                    let status = 'ON TRACK';
                    if (isHistorical) {
                        status = 'COMPLETE';
                    } else if (total >= config.budget) {
                        status = 'OVER BUDGET';
                    } else if (projectedOverBudget > 5) {
                        status = 'HOT';
                    } else if (projectedOverBudget < -5) {
                        status = 'COLD';
                    }

                    processedClients.push({
                        name: clientName,
                        google: currentMetrics.googleSpend,
                        facebook: currentMetrics.facebookSpend,
                        total: total,
                        budget: config.budget,
                        period: config.period,
                        totalDays: config.totalDays,
                        daysLeft: daysLeft,
                        daysElapsed: daysElapsed,
                        used: used,
                        remaining: remaining,
                        status: status,
                        currentDailyBudget: currentDailyBudget,
                        googleDailyBudget: googleDailyBudget,
                        facebookDailyBudget: facebookDailyBudget,
                        projectedSpend: projectedSpend,
                        projectedOverBudget: projectedOverBudget,
                        ctr: currentMetrics.ctr.toFixed(2),
                        careConversions: currentMetrics.careConversions,
                        nursingConversions: currentMetrics.nursingConversions,
                        conversions: currentMetrics.conversions,
                        previousPeriod: previousPeriodData,
                        isHistorical: isHistorical
                    });
                });

                return processedClients;
            }, [clientConfig, getPreviousPeriodDates, selectedMonth]);

            useEffect(() => {
                loadData();
            }, []);

            const dataToUse = useMemo(() => {
                return Object.keys(rawData).length > 0 ? processRawData(rawData, conversionData) : [];
            }, [rawData, conversionData, processRawData]);

            const totalSpend = dataToUse.reduce((sum, client) => sum + client.total, 0);
            const totalDailyBudget = dataToUse.reduce((sum, client) => sum + client.currentDailyBudget, 0);

            return (
                <div className="w-full min-h-screen bg-gray-50 p-4">
                    <div className="max-w-full mx-auto">
                        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900 mb-2">Client Budget Performance Dashboard</h1>
                                    <p className="text-gray-600">
                                        Updated: {new Date().toLocaleString()} | {VERSION}
                                    </p>
                                </div>
                                
                                <div className="mt-4 lg:mt-0 grid grid-cols-2 gap-4 text-center">
                                    <div className="bg-blue-50 p-4 rounded-lg">
                                        <div className="text-2xl font-bold text-blue-600">¬£{totalSpend.toFixed(0)}</div>
                                        <div className="text-sm text-blue-700">Total Spend</div>
                                    </div>
                                    <div className="bg-cyan-50 p-4 rounded-lg">
                                        <div className="text-2xl font-bold text-cyan-600">
                                            {selectedMonth === 'current' ? `¬£${totalDailyBudget.toFixed(0)}` : 'N/A'}
                                        </div>
                                        <div className="text-sm text-cyan-700">Daily Budget</div>
                                    </div>
                                </div>
                            </div>

                            <div className="mt-6 flex flex-wrap items-center gap-4">
                                <MonthSelector
                                    selectedMonth={selectedMonth}
                                    onMonthChange={setSelectedMonth}
                                    availableMonths={availableMonths}
                                />
                                <button
                                    onClick={loadData}
                                    disabled={loading}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors text-sm"
                                >
                                    {loading ? 'Loading...' : 'üîÑ Refresh Data'}
                                </button>
                                <button
                                    onClick={() => setShowLogs(!showLogs)}
                                    className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm"
                                >
                                    {showLogs ? 'üôà Hide Logs' : 'üëÅÔ∏è Show Logs'}
                                </button>
                                {showLogs && (
                                    <button
                                        onClick={clearLogs}
                                        className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm"
                                    >
                                        Clear Logs
                                    </button>
                                )}
                            </div>
                            
                            <div className="mt-4">
                                {loading && <p className="text-sm text-blue-600 mt-1">üîÑ Loading data...</p>}
                                {error && <p className="text-sm text-red-600 mt-1">‚ùå {error}</p>}
                                {Object.keys(rawData).length > 0 && <p className="text-sm text-green-600 mt-1">‚úÖ Processing {Object.keys(rawData).length} data tabs</p>}
                            </div>

                            {showLogs && logs.length > 0 && (
                                <div className="mt-4 animate-in slide-in-from-top duration-300">
                                    <h4 className="text-sm font-medium text-gray-800 mb-2">System Logs:</h4>
                                    <div className="bg-gray-900 text-green-400 p-3 rounded max-h-48 overflow-y-auto font-mono text-xs">
                                        {logs.slice(-30).map((log, index) => (
                                            <div
                                                key={index}
                                                className={
                                                    log.type === 'error' ? 'text-red-400' : 
                                                    log.type === 'success' ? 'text-green-400' : 
                                                    log.type === 'warning' ? 'text-yellow-400' :
                                                    'text-blue-400'
                                                }
                                            >
                                                [{log.timestamp}] {log.message}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="bg-white rounded-lg shadow-sm p-6">
                            <h2 className="text-2xl font-bold mb-6 text-center">
                                {selectedMonth === 'current' ? 'Current Period Performance' : 'Historical Performance'}
                            </h2>
                            
                            {dataToUse.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {dataToUse.map(client => (
                                        <ClientCard key={client.name} client={client} />
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-12">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                    <p className="text-gray-500 text-lg">Loading budget data...</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ClientBudgetTable />);
    </script>
</body>
</html>
